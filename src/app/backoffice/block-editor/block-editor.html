<div class="editor-container">
  <!-- FLUID WIDGET DRAG LAYER -->
  <div class="absolute inset-0 z-50 pointer-events-none w-full h-full" *ngIf="widgetBlocks.length > 0">
    <div *ngFor="let widget of widgetBlocks; let wj = index" 
         cdkDrag 
         [cdkDragFreeDragPosition]="{x: widget.data?.x || -200, y: widget.data?.y || 100}"
         (cdkDragEnded)="onWidgetDragEnded($event, widget)"
         class="absolute pointer-events-auto cursor-move left-0 top-0 group/widget">
         
         <!-- Remove button -->
         <button (click)="removeWidget(wj)" class="btn-delete-node">
            <span class="material-symbols-outlined text-[16px]">close</span>
         </button>
         
         <!-- Widget Renderer -->
         <ng-container>
            <div class="pointer-events-none" [innerHTML]="getWidgetHtml(widget.content)"></div>
         </ng-container>
    </div>
  </div>

  <div class="editor-header">
    <a routerLink="/admin" class="btn-back-nav">
      <span class="material-symbols-outlined text-[16px]">arrow_back</span>
      Back to Dashboard
    </a>
    <div class="header-actions">
      <button (click)="preview()" class="btn-preview flex items-center justify-center gap-2">
        <span class="material-symbols-outlined text-[18px]">visibility</span> Preview
      </button>
      <button (click)="save()" class="btn-publish">
        <span class="material-symbols-outlined text-[18px]">save</span> Publish
      </button>
    </div>
  </div>

  <div class="workspace-box">
    <div class="tape-strip" style="top: -15px; left: 50%; transform: translateX(-50%) rotate(1deg);"></div>
    
    <!-- Publish Animation Sticker -->
    <div *ngIf="showPublishSticker" class="publish-stamp-overlay">
      <div class="publish-stamp">
        Published
      </div>
    </div>
    
    <!-- Document Meta -->
    <div class="doc-meta-section">
      <div>
        <label class="meta-label">Document Title</label>
        <input [(ngModel)]="title" (ngModelChange)="!documentId && (slug = contentService.generateSlug(title))" class="meta-input-title" placeholder="Untitled Entry" type="text" />
      </div>

      <div>
        <label class="meta-label">URL Slug <span class="meta-label-hint">— auto-generated, editable</span></label>
        <div class="meta-slug-box">
          <span class="meta-slug-prefix">tudominio.com/{{ category }}/</span>
          <input [(ngModel)]="slug" class="meta-slug-input" placeholder="mi-proyecto-increible" type="text" />
        </div>
      </div>
      
      <div>
        <label class="meta-label">Cover Photo (URL or File Upload)</label>
        <div class="meta-cover-box">
          <div class="meta-cover-input-group">
            <input [(ngModel)]="coverPhoto" class="meta-cover-input" placeholder="https://example.com/image.jpg" type="text" />
            <button (click)="fileInput.click()" class="btn-upload" title="Upload File">
              <span class="material-symbols-outlined text-[20px]">upload_file</span>
            </button>
            <input type="file" #fileInput (change)="onCoverPhotoSelected($event)" accept="image/*" class="hidden" style="display: none;" />
          </div>
          <div *ngIf="coverPhoto" class="meta-cover-preview">
            <img [src]="coverPhoto" class="meta-cover-img" alt="Cover Preview" />
          </div>
        </div>
      </div>
      
      <div class="meta-row">
        <div>
          <label class="meta-label">Category</label>
          <select [(ngModel)]="category" class="meta-select">
            <option value="work">Work Database</option>
            <option value="log">Field Log</option>
          </select>
        </div>
        <div style="flex-grow: 1;">
          <label class="meta-label">Tags (Comma separated)</label>
          <input [(ngModel)]="tags" class="meta-tags-input" placeholder="e.g. REACT, DESIGN" type="text" />
          
          <!-- System Tags Quick Add -->
          <div *ngIf="systemTags.length > 0" class="meta-quick-tags">
            <button *ngFor="let tag of systemTags" (click)="appendSystemTag(tag)" class="btn-quick-tag">
              + {{tag}}
            </button>
          </div>
        </div>
      </div>

      <div class="meta-row" *ngIf="category === 'work'" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb;">
        <div style="flex-grow: 1;">
          <label class="meta-label">Deploy Status <span class="meta-label-hint">— Fixed Tech Stack Info</span></label>
          <input [(ngModel)]="deployStatus" class="meta-input-title" placeholder="LIVE_PRODUCTION" style="font-family: var(--font-mono); font-size: 0.875rem; background-color: white;" />
        </div>
      </div>

      <div *ngIf="category === 'work'">
        <label class="meta-label">Global Index Log (One item per line)</label>
        <textarea [(ngModel)]="indexLog" readonly class="meta-textarea" placeholder="01_SPECIFICATIONS&#10;02_MISSION_OBJECTIVES&#10;03_SYSTEM_ARCHITECTURE" rows="4"></textarea>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar-container">
      <button (click)="addBlock('h1')" class="btn-toolbar btn-toolbar-h1" title="Add Heading 1">H1</button>
      <button (click)="addBlock('h2')" class="btn-toolbar btn-toolbar-h2" title="Add Heading 2">H2</button>
      <button (click)="addBlock('p')" class="btn-toolbar" title="Add Paragraph">
        <span class="material-symbols-outlined">format_paragraph</span>
      </button>
      <button (click)="addBlock('image')" class="btn-toolbar" title="Add Image">
        <span class="material-symbols-outlined">image</span>
      </button>
      <button (click)="addBlock('video')" class="btn-toolbar" title="Add Video">
        <span class="material-symbols-outlined">videocam</span>
      </button>
      <button (click)="addBlock('code')" class="btn-toolbar" title="Add Code Block">
        <span class="material-symbols-outlined">code</span>
      </button>
      <button (click)="addBlock('objective-header')" class="btn-toolbar" title="Add Objective Header">
        <span class="material-symbols-outlined">hdr_strong</span>
      </button>
      <button (click)="addBlock('objectives')" class="btn-toolbar" title="Add Objectives Grid">
        <span class="material-symbols-outlined">grid_view</span>
      </button>
      <button (click)="addBlock('divider')" class="btn-toolbar" title="Add Divider">
        <span class="material-symbols-outlined">horizontal_rule</span>
      </button>
      <button (click)="addBlock('diagram')" class="btn-toolbar" title="Add Diagram">
        <span class="material-symbols-outlined">account_tree</span>
      </button>
      <div class="toolbar-divider"></div>
      <button (click)="openWidgetGallery()" class="btn-toolbar-stickers" title="Add Sticker/Widget">
        <span class="material-symbols-outlined text-sm">sticky_note_2</span>
        <span class="btn-toolbar-stickers-text">Stickers</span>
      </button>
    </div>

    <!-- Workspace blocks -->
    <div cdkDropList (cdkDropListDropped)="drop($event)" class="blocks-list">
      <!-- Empty state -->
      <div *ngIf="contentBlocks.length === 0" class="blocks-empty" (click)="addBlock('p')">
        Click here or use the toolbar to add a block.
      </div>

      <!-- Render Blocks -->
      <div *ngFor="let block of contentBlocks; let i = index" cdkDrag class="block-item group">
        
        <!-- Drag Handle & Controls -->
        <div class="block-controls">
          <div cdkDragHandle class="btn-drag-handle">
            <span class="material-symbols-outlined text-[16px]">drag_indicator</span>
          </div>
          <button (click)="removeBlock(i)" class="btn-remove-block">
            <span class="material-symbols-outlined text-[16px]">close</span>
          </button>
        </div>

        <!-- Render by block type -->
        <ng-container [ngSwitch]="block.type">
          <input *ngSwitchCase="'h1'" [(ngModel)]="block.content" (ngModelChange)="updateIndexLogLive()" placeholder="Heading 1" class="input-h1" />
          
          <input *ngSwitchCase="'h2'" [(ngModel)]="block.content" (ngModelChange)="updateIndexLogLive()" placeholder="Heading 2" class="input-h2" />
          
          <textarea *ngSwitchCase="'p'" [(ngModel)]="block.content" placeholder="Write something..." class="input-p" rows="2" (input)="autoResize($any($event).target)"></textarea>

          <div *ngSwitchCase="'image'" style="width: 100%;">
            <div *ngIf="!block.content" class="block-image-empty">
              <span class="material-symbols-outlined block-image-empty-icon">add_photo_alternate</span>
              <span class="block-image-empty-text">CLICK TO ADD IMAGE URL</span>
              <input [(ngModel)]="block.content" class="block-image-empty-input" placeholder="https://..." (click)="$event.stopPropagation()"/>
            </div>
            <div *ngIf="block.content" class="block-image-filled">
              <img [src]="block.content" class="block-image-item riso-print" alt="Block image" />
              <button (click)="block.content = ''" class="btn-delete-image">
                <span class="material-symbols-outlined text-[18px]">delete</span>
              </button>
            </div>
          </div>

          <div *ngSwitchCase="'code'" class="block-code-wrapper">
            <textarea [(ngModel)]="block.content" placeholder="// Write code here..." class="block-code-textarea" rows="4"></textarea>
          </div>

          <div *ngSwitchCase="'video'" class="block-video-wrapper">
            <!-- Empty state: source selector + input -->
            <div *ngIf="!block.content" class="block-video-empty">
              <span class="material-symbols-outlined block-video-icon">videocam</span>
              <div class="block-video-source-options">
                <label class="block-video-radio-label">
                  <input type="radio" [value]="'youtube'" [(ngModel)]="block.data.source" name="videoSource_{{block.id}}" />
                  <span class="block-video-radio-text">YouTube</span>
                </label>
                <label class="block-video-radio-label">
                  <input type="radio" [value]="'upload'" [(ngModel)]="block.data.source" name="videoSource_{{block.id}}" />
                  <span class="block-video-radio-text">Upload</span>
                </label>
              </div>
              <!-- YouTube URL input -->
              <div *ngIf="block.data.source === 'youtube'" class="block-video-url-wrapper">
                <input [(ngModel)]="block.content" class="block-video-url-input" placeholder="https://youtube.com/watch?v=..." (click)="$event.stopPropagation()" />
              </div>
              <!-- File upload -->
              <div *ngIf="block.data.source === 'upload'" class="block-video-upload-wrapper">
                <button (click)="videoFileInput.click()" class="btn-video-upload" [disabled]="isUploadingVideo">
                  <span *ngIf="!isUploadingVideo" style="display: flex; align-items: center; gap: 0.25rem;">
                    <span class="material-symbols-outlined text-[16px]">upload</span> SELECT VIDEO FILE
                  </span>
                  <span *ngIf="isUploadingVideo" style="display: flex; align-items: center; gap: 0.25rem; animation: pulse 2s infinite;">
                    <span class="material-symbols-outlined text-[16px]" style="animation: spin 1s linear infinite;">progress_activity</span> UPLOADING...
                  </span>
                </button>
                <input type="file" #videoFileInput (change)="onVideoFileSelected($event, block)" accept="video/*" class="hidden" style="display:none;" />
              </div>
            </div>
            <!-- Filled state: preview -->
            <div *ngIf="block.content" class="block-video-filled">
              <!-- YouTube embed -->
              <div *ngIf="isYoutubeUrl(block.content)" class="block-video-iframe-wrapper">
                <iframe [src]="getSafeVideoUrl(block.content)" class="block-video-iframe" frameborder="0" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
              </div>
              <!-- Direct video -->
              <div *ngIf="!isYoutubeUrl(block.content)" style="width: 100%;">
                <video [src]="block.content" controls class="block-video-direct-item"></video>
              </div>
              <button (click)="block.content = ''" class="btn-delete-image" style="z-index: 10;">
                <span class="material-symbols-outlined text-[18px]">delete</span>
              </button>
            </div>
          </div>

          <div *ngSwitchCase="'objective-header'" style="width: 100%; display: flex; flex-direction: column; gap: 1rem; padding: 0.5rem 0; border-bottom: 2px solid var(--charcoal);">
            <div style="display: flex; flex-wrap: wrap; align-items: center;">
              <input [(ngModel)]="block.data.title" placeholder="Main Title (e.g. 02_MISSION_OBJECTIVES)" class="input-obj-header-title" />
              <input [(ngModel)]="block.data.subtitle" placeholder="Subtitle (e.g. /TARGETS)" class="input-obj-header-subtitle" />
            </div>
          </div>

          <div *ngSwitchCase="'objectives'" class="block-objectives-wrapper">
             <div class="block-objectives-title">Objectives Grid</div>
             <div class="block-objectives-grid">
               <div *ngFor="let obj of block.data; let j = index" class="block-objective-card">
                 <input [(ngModel)]="obj.label" placeholder="OBJ_LABEL" class="input-obj-label" />
                 <input [(ngModel)]="obj.title" placeholder="Title" class="input-obj-title" />
                 <textarea [(ngModel)]="obj.desc" placeholder="Description" class="input-obj-desc" rows="3"></textarea>
                 <div class="obj-progress-row">
                   <span class="obj-progress-label">Progress %</span>
                   <input type="number" [(ngModel)]="obj.progress" class="input-obj-progress" />
                 </div>
               </div>
             </div>
          </div>

          <div *ngSwitchCase="'divider'" style="width: 100%; padding: 1rem; text-align: center; color: #9ca3af; font-family: var(--font-mono); font-size: 0.75rem; background-color: #f9fafb; border: 2px dashed #e5e7eb;">
            --- Divider (Sketch line) ---
          </div>


          <div *ngSwitchCase="'diagram'" class="block-diagram-wrapper">
            <div class="diagram-preview-badge">
              <span class="material-symbols-outlined text-[12px]">build</span> SYSTEM_DIAGRAM
            </div>
            
            <div class="diagram-preview-header">
              <span class="diagram-preview-title">DIAGRAM PREVIEW</span>
              <button (click)="openDiagramEditor(block)" class="btn-edit-diagram">
                <span class="material-symbols-outlined text-[14px]">edit</span> Edit Diagram
              </button>
            </div>

            <!-- Diagram Canvas Preview -->
            <div class="diagram-preview-canvas">
              <!-- SVG Arrow Overlay for Preview -->
              <svg style="position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
                <defs>
                  <marker id="prev-arrowhead-solid" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto"><polygon points="0 0, 12 4, 0 8" fill="#1a1a1a" /></marker>
                  <marker id="prev-arrowhead-dashed" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto"><polygon points="0 0, 12 4, 0 8" fill="#1a1a1a" /></marker>
                  <marker id="prev-arrowhead-zigzag" markerWidth="14" markerHeight="10" refX="12" refY="5" orient="auto"><polygon points="0 0, 14 5, 0 10" fill="#d94e1e" /></marker>
                  <marker id="prev-arrowhead-graffiti" markerWidth="16" markerHeight="12" refX="14" refY="6" orient="auto"><circle cx="8" cy="6" r="5" fill="#1a1a1a" opacity="0.7" /></marker>
                  <marker id="prev-arrowhead-dotted" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto"><circle cx="5" cy="5" r="4" fill="#1a1a1a" /></marker>
                </defs>
                <ng-container *ngFor="let arrow of block.data?.arrows">
                  <line
                    [attr.x1]="getNodeEdgePoint(block, arrow.from, arrow.to).x"
                    [attr.y1]="getNodeEdgePoint(block, arrow.from, arrow.to).y"
                    [attr.x2]="getNodeEdgePoint(block, arrow.to, arrow.from).x"
                    [attr.y2]="getNodeEdgePoint(block, arrow.to, arrow.from).y"
                    [attr.stroke]="arrow.type === 'zigzag' ? '#d94e1e' : '#1a1a1a'"
                    [attr.stroke-width]="getArrowStrokeWidth(arrow.type)"
                    [attr.stroke-dasharray]="getArrowDashArray(arrow.type) === 'none' ? null : getArrowDashArray(arrow.type)"
                    [attr.marker-end]="getMarkerUrl(arrow.type, 'prev-arrowhead-')"
                    [attr.opacity]="arrow.type === 'graffiti' ? 0.6 : 1"
                    stroke-linecap="round"
                  />
                </ng-container>
              </svg>
              <div *ngFor="let node of block.data?.nodes; let ni = index" 
                   style="position: absolute; pointer-events: auto;" 
                   [style.left.px]="node.x" [style.top.px]="node.y">
              
              <div style="position: relative;" class="group/node">
                 <div *ngIf="node.type === 'postgres'" style="background-color: white; border: 2px solid var(--charcoal); padding: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 120px; box-shadow: 4px 4px 0 #e5e7eb;">
                    <span class="material-symbols-outlined" style="color: #6b7280; margin-bottom: 0.25rem;">database</span>
                    <div style="font-size: 10px; font-family: var(--font-mono); font-weight: bold; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{node.label || 'Database'}}</div>
                 </div>
                 
                 <div *ngIf="node.type === 'api'" style="background-color: var(--accent-orange); color: white; border: 2px solid var(--charcoal); width: 5rem; height: 5rem; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 4px 4px 0 var(--charcoal);">
                    <span class="material-symbols-outlined" style="margin-bottom: 0.25rem;">hub</span>
                    <div style="font-size: 9px; font-family: var(--font-mono); font-weight: bold; text-align: center; width: 100%; padding: 0 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{node.label || 'API'}}</div>
                 </div>
                 
                 <div *ngIf="node.type === 'client' || node.type === 'mobile'" style="background-color: white; border: 2px solid var(--charcoal); padding: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 100px; box-shadow: 4px 4px 0 #e5e7eb;">
                    <span class="material-symbols-outlined" style="color: #0d9488; margin-bottom: 0.25rem;">{{ node.type === 'client' ? 'devices' : 'phone_iphone' }}</span>
                    <div style="font-size: 10px; font-family: var(--font-mono); font-weight: bold; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{node.label || 'Client'}}</div>
                 </div>
                 
                 <div *ngIf="node.type === 'text'" style="transform: rotate(-2deg);">
                   <div style="background-color: transparent; font-family: var(--font-hand); font-size: 1.25rem; color: var(--charcoal);">{{node.label || 'Note'}}</div>
                 </div>

                 <!-- Custom Node from Design Studio -->
                 <div *ngIf="node.type === 'custom' && node.config"
                   style="padding: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 100px;"
                   [style.background-color]="getBgColor(node.config.bg_color)"
                   [style.color]="getTextColor(node.config.text_color)"
                   [style.border]="getBorderCss(node.config.border_style)"
                   [style.box-shadow]="getShadowCss(node.config.shadow_style)"
                   [style.border-radius]="node.config.shape === 'circle' ? '50%' : '0'"
                   [style.width]="node.config.shape === 'circle' ? '100px' : 'auto'"
                   [style.height]="node.config.shape === 'circle' ? '100px' : 'auto'"
                   [style.font-family]="getFontFamily(node.config.font || 'font-mono')">
                    <span *ngIf="node.config.icon" class="material-symbols-outlined" style="margin-bottom: 0.25rem;">{{ node.config.icon }}</span>
                    <div style="font-size: 10px; font-family: var(--font-mono); font-weight: bold; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{node.label || 'Custom'}}</div>
                 </div>
              </div>
            </div>

            </div>
          </div>
        </ng-container>

      </div>
    </div>
  </div>
</div>

<!-- Diagram Editor Modal -->
<div *ngIf="editingDiagramBlock" class="modal-overlay modal-overlay-blur">
  <div class="diagram-modal-box">
    
    <!-- Modal Header -->
    <div class="diagram-modal-header">
      <div class="diagram-modal-nodes-group">
        <span class="diagram-modal-label">ADD NODE:</span>
        <button (click)="addDiagramNode(editingDiagramBlock, 'postgres', 'Postgres Cluster')" class="btn-add-node">Database</button>
        <button (click)="addDiagramNode(editingDiagramBlock, 'api', 'GQL_API')" class="btn-add-node">API Core</button>
        <button (click)="addDiagramNode(editingDiagramBlock, 'client', 'Client App')" class="btn-add-node">Client</button>
        <button (click)="addDiagramNode(editingDiagramBlock, 'mobile', 'Mobile PWA')" class="btn-add-node">Mobile</button>
        <button (click)="addDiagramNode(editingDiagramBlock, 'text', 'Note Text')" class="btn-add-node">Text Note</button>
        
        <!-- Custom Nodes from Design Studio -->
        <ng-container *ngIf="availableDiagramNodes().length > 0">
          <div class="toolbar-divider" style="height: 1.5rem;"></div>
          <button *ngFor="let dn of availableDiagramNodes()" (click)="addCustomDiagramNode(editingDiagramBlock, dn)" class="btn-add-node btn-add-node-custom">
            <span *ngIf="dn.icon" class="material-symbols-outlined text-[14px]">{{ dn.icon }}</span>
            {{ dn.name }}
          </button>
        </ng-container>
      </div>
      
      <button (click)="closeDiagramEditor()" class="btn-diagram-done">
        <span class="material-symbols-outlined text-[18px]">check</span> DONE
      </button>
    </div>

    <!-- Arrow Toolbar -->
    <div class="diagram-toolbar">
      <button (click)="toggleArrowMode()"
        [class]="arrowMode ? 'btn-arrow-mode-active' : 'btn-arrow-mode-inactive'"
        class="btn-arrow-mode">
        <span class="material-symbols-outlined text-[16px]">{{ arrowMode ? 'link_off' : 'link' }}</span>
        {{ arrowMode ? 'EXIT CONNECT' : 'CONNECT NODES' }}
      </button>

      <ng-container *ngIf="arrowMode">
        <div class="diagram-toolbar-divider"></div>
        <span class="diagram-toolbar-label">STYLE:</span>
        <button *ngFor="let at of arrowTypes" (click)="selectedArrowType = at.id"
          [class]="selectedArrowType === at.id ? 'btn-arrow-type-active' : 'btn-arrow-type-inactive'"
          class="btn-arrow-type"
          [title]="at.desc">
          {{ at.label }}
        </button>
        <div class="diagram-toolbar-divider"></div>
        <span *ngIf="arrowFromNode" class="diagram-status-text diagram-status-target">CLICK TARGET NODE...</span>
        <span *ngIf="!arrowFromNode" class="diagram-status-text diagram-status-source">CLICK SOURCE NODE</span>
      </ng-container>

      <!-- Arrow List for deletion -->
      <ng-container *ngIf="editingDiagramBlock.data?.arrows?.length">
        <div class="diagram-toolbar-divider"></div>
        <span class="diagram-toolbar-label" style="margin-right:0;">{{ editingDiagramBlock.data!.arrows!.length }} CONNECTIONS</span>
        <button (click)="editingDiagramBlock.data!.arrows = []" class="btn-clear-arrows">
          CLEAR ALL
        </button>
      </ng-container>
    </div>

    <!-- Modal Canvas Space -->
    <div class="diagram-modal-canvas-area">
      <div class="diagram-modal-canvas-box" id="diagram-editor-canvas">
        
        <!-- SVG Arrow Overlay -->
        <svg style="position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
          <defs>
            <!-- Brutalist arrowhead -->
            <marker id="arrowhead-solid" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto">
              <polygon points="0 0, 12 4, 0 8" fill="#1a1a1a" />
            </marker>
            <marker id="arrowhead-dashed" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto">
              <polygon points="0 0, 12 4, 0 8" fill="#1a1a1a" />
            </marker>
            <marker id="arrowhead-zigzag" markerWidth="14" markerHeight="10" refX="12" refY="5" orient="auto">
              <polygon points="0 0, 14 5, 0 10" fill="#d94e1e" />
            </marker>
            <marker id="arrowhead-graffiti" markerWidth="16" markerHeight="12" refX="14" refY="6" orient="auto">
              <circle cx="8" cy="6" r="5" fill="#1a1a1a" opacity="0.7" />
            </marker>
            <marker id="arrowhead-dotted" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto">
              <circle cx="5" cy="5" r="4" fill="#1a1a1a" />
            </marker>
          </defs>

          <ng-container *ngFor="let arrow of editingDiagramBlock.data?.arrows; let ai = index">
            <line
              [attr.x1]="getNodeEdgePoint(editingDiagramBlock, arrow.from, arrow.to).x"
              [attr.y1]="getNodeEdgePoint(editingDiagramBlock, arrow.from, arrow.to).y"
              [attr.x2]="getNodeEdgePoint(editingDiagramBlock, arrow.to, arrow.from).x"
              [attr.y2]="getNodeEdgePoint(editingDiagramBlock, arrow.to, arrow.from).y"
              [attr.stroke]="arrow.type === 'zigzag' ? '#d94e1e' : '#1a1a1a'"
              [attr.stroke-width]="getArrowStrokeWidth(arrow.type)"
              [attr.stroke-dasharray]="getArrowDashArray(arrow.type) === 'none' ? null : getArrowDashArray(arrow.type)"
              [attr.marker-end]="getMarkerUrl(arrow.type)"
              [attr.opacity]="arrow.type === 'graffiti' ? 0.6 : 1"
              stroke-linecap="round"
            />
          </ng-container>
        </svg>

        <div *ngFor="let node of editingDiagramBlock.data?.nodes; let ni = index" 
             cdkDrag [cdkDragBoundary]="'#diagram-editor-canvas'" 
             [cdkDragFreeDragPosition]="{x: node.x, y: node.y}"
             class="diagram-node-draggable" 
             [style.cursor]="arrowMode ? 'crosshair' : 'move'"
             (cdkDragEnded)="onNodeDragEnded($event, node)"
             (click)="onNodeClickForArrow(node.id)">
          
          <div class="diagram-node-inner"
            [class.diagram-node-inner-active]="arrowFromNode === node.id"
            class="group/node">
             <button (click)="editingDiagramBlock.data!.nodes.splice(ni, 1); $event.stopPropagation()" class="btn-delete-node">×</button>
             
             <div *ngIf="node.type === 'postgres'" style="background-color: white; border: 2px solid var(--charcoal); padding: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 120px; box-shadow: 4px 4px 0 #e5e7eb;">
                <span class="material-symbols-outlined" style="color: #6b7280; margin-bottom: 0.25rem;">database</span>
                <input [(ngModel)]="node.label" class="input-node-label" />
             </div>
             
             <div *ngIf="node.type === 'api'" style="background-color: var(--accent-orange); color: white; border: 2px solid var(--charcoal); width: 5rem; height: 5rem; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 4px 4px 0 var(--charcoal);">
                <span class="material-symbols-outlined" style="margin-bottom: 0.25rem;">hub</span>
                <input [(ngModel)]="node.label" class="input-node-label input-node-label-small" />
             </div>
             
             <div *ngIf="node.type === 'client' || node.type === 'mobile'" style="background-color: white; border: 2px solid var(--charcoal); padding: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 100px; box-shadow: 4px 4px 0 #e5e7eb;">
                <span class="material-symbols-outlined" style="color: #0d9488; margin-bottom: 0.25rem;">{{ node.type === 'client' ? 'devices' : 'phone_iphone' }}</span>
                <input [(ngModel)]="node.label" class="input-node-label" />
             </div>
             
             <div *ngIf="node.type === 'text'" style="transform: rotate(-2deg);">
               <textarea [(ngModel)]="node.label" class="input-node-text" placeholder="Type here..." rows="2"></textarea>
             </div>

             <!-- Custom Node from Design Studio -->
             <div *ngIf="node.type === 'custom' && node.config" 
               style="padding: 0.75rem; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 100px;"
               [style.background-color]="getBgColor(node.config.bg_color)"
               [style.color]="getTextColor(node.config.text_color)"
               [style.border]="getBorderCss(node.config.border_style)"
               [style.box-shadow]="getShadowCss(node.config.shadow_style)"
               [style.border-radius]="node.config.shape === 'circle' ? '50%' : '0'"
               [style.width]="node.config.shape === 'circle' ? '100px' : 'auto'"
               [style.height]="node.config.shape === 'circle' ? '100px' : 'auto'"
               [style.font-family]="getFontFamily(node.config.font || 'font-mono')">
                <span *ngIf="node.config.icon" class="material-symbols-outlined" style="margin-bottom: 0.25rem;">{{ node.config.icon }}</span>
                <input [(ngModel)]="node.label" class="input-node-label" />
             </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Widget Gallery Modal -->
<div *ngIf="showWidgetGallery" class="modal-overlay modal-overlay-blur">
  <div class="gallery-modal-box">
    <!-- Header -->
    <div class="gallery-modal-header">
      <div class="gallery-modal-title-group">
        <span class="material-symbols-outlined text-accent-orange">sticky_note_2</span>
        <h2 class="gallery-modal-title">Widget Gallery</h2>
        <span class="gallery-modal-badge">DECORATIVE_ELEMENTS</span>
      </div>
      <button (click)="closeWidgetGallery()" class="btn-close-gallery">
        <span class="material-symbols-outlined" style="font-size: 24px;">close</span>
      </button>
    </div>
    
    <!-- Gallery Grid -->
    <div class="gallery-grid">
      
      <div *ngFor="let widget of availableWidgets()" 
           (click)="addWidget(widget.id!)" 
           class="gallery-item group">
        
        <div class="gallery-item-bg"></div>
        <!-- Render the actual widget for preview -->
        <div class="gallery-item-content" [innerHTML]="getWidgetHtml(widget.id!)"></div>
        <div class="gallery-item-label">{{ widget.name }}</div>
      </div>

    </div>
  </div>
</div>
