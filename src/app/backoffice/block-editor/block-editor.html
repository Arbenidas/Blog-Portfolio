<div class="editor-container">
  <div class="editor-header" *ngIf="!zenMode">
    <a routerLink="/admin" class="btn-back-nav">
      <span class="material-symbols-outlined text-[16px]">arrow_back</span>
      Back to Dashboard
    </a>
    <div class="header-actions">
      <span *ngIf="lastAutoSaveTime" style="font-family: var(--font-mono); font-size: 0.7rem; color: #9ca3af;">
        Autoguardado: {{ lastAutoSaveTime }}
      </span>

      <div style="display: flex; align-items: center; border: 2px solid var(--charcoal); background: white; border-radius: 4px; overflow: hidden; margin-right: 0.5rem;">
        <label [style.background]="documentStatus === 'draft' ? '#fcd34d' : 'transparent'"
               style="padding: 0.4rem 0.75rem; cursor: pointer; font-family: var(--font-mono); font-size: 0.75rem; font-weight: bold; border-right: 2px solid var(--charcoal); display: flex; align-items: center; gap: 0.25rem; margin: 0;">
          <input type="radio" [(ngModel)]="documentStatus" value="draft" style="display: none;">
          <span class="material-symbols-outlined" style="font-size: 14px;">edit_document</span>
          DRAFT
        </label>
        <label [style.background]="documentStatus === 'published' ? '#86efac' : 'transparent'"
               style="padding: 0.4rem 0.75rem; cursor: pointer; font-family: var(--font-mono); font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; gap: 0.25rem; margin: 0;">
          <input type="radio" [(ngModel)]="documentStatus" value="published" style="display: none;">
          <span class="material-symbols-outlined" style="font-size: 14px;">public</span>
          PUBLISH
        </label>
      </div>

      <button (click)="preview()" class="btn-preview flex items-center justify-center gap-2" [disabled]="isUploadingCover">
        <span *ngIf="!isUploadingCover" class="material-symbols-outlined text-[18px]">visibility</span>
        <span *ngIf="isUploadingCover" class="material-symbols-outlined text-[18px]" style="animation: spin 1s linear infinite;">progress_activity</span>
        {{ isUploadingCover ? 'Uploading...' : 'Preview' }}
      </button>
      <button (click)="save()" class="btn-publish" [disabled]="isUploadingCover">
        <span class="material-symbols-outlined text-[18px]">save</span> Publish
      </button>
    </div>
  </div>

  <div class="workspace-box" [class.zen-mode-active]="zenMode" [class.theme-docs]="category === 'guide'">
    <div class="tape-strip" *ngIf="!zenMode && category !== 'guide'" style="top: -15px; left: 50%; transform: translateX(-50%) rotate(1deg);"></div>
    
    <!-- Publish Animation Sticker -->
    <div *ngIf="showPublishSticker && !zenMode" class="publish-stamp-overlay">
      <div class="publish-stamp">
        Published
      </div>
    </div>
    
    <!-- Document Meta -->
    <div class="doc-meta-section" *ngIf="!zenMode">
      <div>
        <label class="meta-label">Document Title</label>
        <input [(ngModel)]="title" (ngModelChange)="!documentId && (slug = contentService.generateSlug(title))" class="meta-input-title" placeholder="Untitled Entry" type="text" />
      </div>

      <div>
        <label class="meta-label">URL Slug <span class="meta-label-hint">— auto-generated, editable</span></label>
        <div class="meta-slug-box">
          <span class="meta-slug-prefix">tudominio.com/{{ category }}/</span>
          <input [(ngModel)]="slug" class="meta-slug-input" placeholder="mi-proyecto-increible" type="text" />
        </div>
      </div>
      
      <div>
        <label class="meta-label">Cover Photo Banner Preview</label>
        <div class="meta-cover-box" style="padding: 0; overflow: hidden; border-radius: 4px;">
          
          <div class="meta-cover-input-group" style="margin: 1rem; border: 2px solid #1a1a1a;">
            <input [(ngModel)]="coverPhotoUrl" class="meta-cover-input" placeholder="https://example.com/image.jpg" type="text" style="border: none;" />
            <button (click)="fileInput.click()" class="btn-upload" style="border-left: 2px solid #1a1a1a; background: #f9fafb;" title="Upload File" [disabled]="isUploadingCover">
              <span *ngIf="!isUploadingCover" class="material-symbols-outlined text-[20px]">upload_file</span>
              <span *ngIf="isUploadingCover" class="material-symbols-outlined text-[20px]" style="animation: spin 1s linear infinite;">progress_activity</span>
            </button>
            <input type="file" #fileInput (change)="onCoverPhotoSelected($event)" accept="image/*" class="hidden" style="display: none;" />
          </div>
          <!-- Pending upload badge -->
          <div *ngIf="pendingCoverFile" style="margin: 0 1rem 0.5rem; padding: 0.4rem 0.75rem; background: #fef9c3; border: 2px solid #1a1a1a; font-family: var(--font-mono); font-size: 0.7rem; font-weight: bold; display: flex; align-items: center; gap: 0.5rem;">
            <span class="material-symbols-outlined" style="font-size: 16px; color: #d97706;">pending</span>
            IMAGEN PENDIENTE — Se subirá a Supabase al hacer Preview o Publish
          </div>

          <div *ngIf="coverPhotoUrl" style="padding-top: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <span style="color: var(--charcoal); font-family: var(--font-mono); font-size: 0.75rem; font-weight: bold;">
                {{ category === 'work' ? '16:9 WORK BANNER' : 'FIELD LOG BANNER (16rem)' }} PREVIEW
              </span>
              <span style="color: #9ca3af; font-family: var(--font-mono); font-size: 0.65rem;">Click & Drag to reposition</span>
            </div>
            
            <div [style.aspect-ratio]="category === 'work' ? '16/9' : 'unset'"
                 [style.height]="category === 'log' ? '16rem' : 'auto'"
                 (mousedown)="onBannerDragStart($event)"
                 (mousemove)="onBannerDragMove($event)"
                 (mouseup)="onBannerDragEnd()"
                 (mouseleave)="onBannerDragEnd()"
                 (touchstart)="onBannerDragStart($event)"
                 (touchmove)="onBannerDragMove($event)"
                 (touchend)="onBannerDragEnd()"
                 [style.cursor]="isDraggingBanner ? 'grabbing' : 'grab'"
                 style="width: 100%; overflow: hidden; background-color: #f3f4f6; position: relative; border: 2px solid var(--charcoal); box-shadow: var(--shadow-sketch); touch-action: none; margin-bottom: 1rem;">
              
              <img [src]="coverPhotoUrl" 
                   [style.object-position]="coverPosX + '% ' + coverPosY + '%'"
                   [style.transform-origin]="coverPosX + '% ' + coverPosY + '%'"
                   [style.transform]="'scale(' + (coverScale / 100) + ')'"
                   style="width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none;" 
                   alt="Banner Preview" />
            </div>

            <div style="padding: 1rem; display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; background: var(--paper-cream); border: 1px dashed #d1d5db;">
               
               <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                 <span class="material-symbols-outlined" style="color: var(--accent-orange); font-size: 20px;">swipe</span>
                 <span style="font-family: var(--font-mono); font-size: 0.7rem; color: #6b7280; text-transform: uppercase; font-weight: bold;">
                   Drag image to adjust framing
                 </span>
               </div>
               
               <div style="flex: 1; min-width: 200px;">
                 <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                   <label style="font-family: var(--font-mono); font-size: 0.75rem; font-weight: bold; color: var(--charcoal);">Zoom Scale</label>
                   <span style="font-family: var(--font-mono); font-size: 0.75rem; color: var(--charcoal); font-weight: bold;">{{coverScale}}%</span>
                 </div>
                 <input type="range" min="100" max="250" [(ngModel)]="coverScale" style="width: 100%; accent-color: var(--accent-orange);">
               </div>
               
            </div>
          </div>

        </div>
      </div>
      
      <div class="meta-row">
        <div>
          <label class="meta-label">Category</label>
          <select [(ngModel)]="category" class="meta-select">
            <option value="work">Work Database</option>
            <option value="guide">Field Guide</option>
            <option value="log">Field Log</option>
          </select>
        </div>
        <div style="flex-grow: 1;">
          <label class="meta-label">Tags (Comma separated)</label>
          <input [(ngModel)]="tags" class="meta-tags-input" placeholder="e.g. REACT, DESIGN" type="text" />
          
          <!-- System Tags Quick Add -->
          <div *ngIf="systemTags.length > 0" class="meta-quick-tags">
            <button *ngFor="let tag of systemTags" (click)="appendSystemTag(tag)" class="btn-quick-tag">
              + {{tag}}
            </button>
          </div>
        </div>
      </div>

      <div class="meta-row" *ngIf="category === 'work'" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb;">
        <div style="flex-grow: 1;">
          <label class="meta-label">Deploy Status <span class="meta-label-hint">— Fixed Tech Stack Info</span></label>
          <input [(ngModel)]="deployStatus" class="meta-input-title" placeholder="LIVE_PRODUCTION" style="font-family: var(--font-mono); font-size: 0.875rem; background-color: white;" />
        </div>
      </div>

      <div *ngIf="category === 'work'">
        <label class="meta-label">Global Index Log (One item per line)</label>
        <textarea [(ngModel)]="indexLog" readonly class="meta-textarea" placeholder="01_SPECIFICATIONS&#10;02_MISSION_OBJECTIVES&#10;03_SYSTEM_ARCHITECTURE" rows="4"></textarea>
      </div>

      <div style="margin-top: 1rem; border-top: 1px dashed #e5e7eb; padding-top: 1rem;">
        <label class="meta-label">Bibliography / References (Optional) <span class="meta-label-hint">— Appears at the end of the document</span></label>
        <textarea [(ngModel)]="bibliography" class="meta-textarea" placeholder="Links, books, or articles used as reference..." rows="3"></textarea>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar-container">
      <button (click)="toggleZenMode()" class="btn-toolbar" [title]="zenMode ? 'Exit Zen Mode' : 'Enter Zen Mode'">
        <span class="material-symbols-outlined" [style.color]="zenMode ? '#d94e1e' : 'inherit'">
          {{ zenMode ? 'close_fullscreen' : 'fullscreen' }}
        </span>
      </button>
      
      <div class="toolbar-divider"></div>

      <button (click)="addBlock('h1')" class="btn-toolbar btn-toolbar-h1" title="Add Heading 1">H1</button>
      <button (click)="addBlock('h2')" class="btn-toolbar btn-toolbar-h2" title="Add Heading 2">H2</button>
      <button (click)="addBlock('p')" class="btn-toolbar" title="Add Paragraph">
        <span class="material-symbols-outlined">format_paragraph</span>
      </button>
      <button (click)="addBlock('image')" class="btn-toolbar" title="Add Image">
        <span class="material-symbols-outlined">image</span>
      </button>
      <button (click)="addBlock('gallery')" class="btn-toolbar" title="Add Gallery">
        <span class="material-symbols-outlined">auto_awesome_mosaic</span>
      </button>
      <button (click)="addBlock('video')" class="btn-toolbar" title="Add Video">
        <span class="material-symbols-outlined">videocam</span>
      </button>
      <button (click)="addBlock('code')" class="btn-toolbar" title="Add Code Block">
        <span class="material-symbols-outlined">code</span>
      </button>
      <button (click)="addBlock('objective-header')" class="btn-toolbar" title="Add Objective Header">
        <span class="material-symbols-outlined">hdr_strong</span>
      </button>
      <button (click)="addBlock('objectives')" class="btn-toolbar" title="Add Objectives Grid">
        <span class="material-symbols-outlined">grid_view</span>
      </button>
      <button (click)="addBlock('divider')" class="btn-toolbar" title="Add Divider">
        <span class="material-symbols-outlined">horizontal_rule</span>
      </button>
      <button (click)="addBlock('diagram')" class="btn-toolbar" title="Add Diagram">
        <span class="material-symbols-outlined">account_tree</span>
      </button>
      <button (click)="addBlock('blockquote')" class="btn-toolbar" title="Add Blockquote">
        <span class="material-symbols-outlined">format_quote</span>
      </button>
      <button (click)="addComparisonBlock()" class="btn-toolbar" title="Insertar Cuadro Comparativo">
        <span class="material-symbols-outlined">splitscreen</span>
      </button>
      <div class="toolbar-divider"></div>
    </div>

    <!-- Workspace blocks -->
    <div cdkDropList (cdkDropListDropped)="drop($event)" class="blocks-list">
      <!-- Empty state -->
      <div *ngIf="contentBlocks.length === 0" class="blocks-empty" (click)="addBlock('p')">
        Click here or use the toolbar to add a block.
      </div>

      <!-- Render Blocks -->
      <div *ngFor="let block of contentBlocks; let i = index" cdkDrag class="block-item group">
        
        <!-- Drag Handle & Controls -->
        <div class="block-controls">
          <div cdkDragHandle class="btn-drag-handle">
            <span class="material-symbols-outlined text-[16px]">drag_indicator</span>
          </div>
          <button (click)="removeBlock(i)" class="btn-remove-block">
            <span class="material-symbols-outlined text-[16px]">close</span>
          </button>
        </div>

        <!-- Render by block type -->
        <ng-container [ngSwitch]="block.type">
          <input *ngSwitchCase="'h1'" [(ngModel)]="block.content" (ngModelChange)="updateIndexLogLive()" 
                 id="block-input-{{i}}" (keydown)="onBlockKeyDown($event, i)" 
                 (focus)="centerActiveBlock(i)"
                 placeholder="Heading 1" class="input-h1" />
          
          <input *ngSwitchCase="'h2'" [(ngModel)]="block.content" (ngModelChange)="updateIndexLogLive()" 
                 id="block-input-{{i}}" (keydown)="onBlockKeyDown($event, i)" 
                 (focus)="centerActiveBlock(i)"
                 placeholder="Heading 2" class="input-h2" />
          
          <textarea *ngSwitchCase="'p'" [(ngModel)]="block.content" 
                    id="block-input-{{i}}" 
                    (keydown)="onBlockKeyDown($event, i)"
                    (input)="onBlockInput($event, i); autoResize($any($event).target)"
                    (focus)="centerActiveBlock(i)"
                    placeholder="Escribe algo o teclea '/' para comandos..." 
                    class="input-p" rows="1"></textarea>

          <textarea *ngSwitchCase="'blockquote'" [(ngModel)]="block.content" 
                    id="block-input-{{i}}" 
                    (keydown)="onBlockKeyDown($event, i)"
                    (input)="onBlockInput($event, i); autoResize($any($event).target)"
                    (focus)="centerActiveBlock(i)"
                    placeholder="Escribe una cita importante..." 
                    class="input-blockquote" rows="2"></textarea>

          <div *ngSwitchCase="'image'" style="width: 100%;">
            <div *ngIf="!block.content" class="block-image-empty">
              <span class="material-symbols-outlined block-image-empty-icon">add_photo_alternate</span>
              <span class="block-image-empty-text">CLICK TO ADD IMAGE URL</span>
              <input [(ngModel)]="block.content" class="block-image-empty-input" placeholder="https://..." (click)="$event.stopPropagation()"/>
            </div>
            <div *ngIf="block.content" class="block-image-filled clearfix" style="position: relative;">
              
              <!-- Image Formatting Controls -->
              <div class="block-image-controls" style="position: absolute; top: 0.5rem; left: 0.5rem; display: flex; gap: 0.5rem; background: rgba(255,255,255,0.9); padding: 0.25rem 0.5rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10;">
                
                <!-- Size Controls -->
                <div style="display: flex; gap: 0.2rem; align-items: center; border-right: 1px solid #ccc; padding-right: 0.5rem;">
                  <button (click)="block.data.size = 'small'" [class.active-ctrl]="block.data?.size === 'small'" title="Small Size" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer; border-radius: 4px;">
                    <span class="material-symbols-outlined" style="font-size: 16px;">photo_size_select_small</span>
                  </button>
                  <button (click)="block.data.size = 'medium'" [class.active-ctrl]="block.data?.size === 'medium'" title="Medium Size" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer; border-radius: 4px;">
                    <span class="material-symbols-outlined" style="font-size: 16px;">photo_size_select_large</span>
                  </button>
                  <button (click)="block.data.size = 'full'" [class.active-ctrl]="block.data?.size === 'full' || !block.data?.size" title="Full Width" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer; border-radius: 4px;">
                    <span class="material-symbols-outlined" style="font-size: 16px;">photo_size_select_actual</span>
                  </button>
                </div>

                <!-- Alignment Controls -->
                <div style="display: flex; gap: 0.2rem; align-items: center;">
                  <button (click)="block.data.align = 'left'" [class.active-ctrl]="block.data?.align === 'left'" title="Align Left (Float)" [disabled]="block.data?.size === 'full'" [style.opacity]="block.data?.size === 'full' ? '0.5' : '1'" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer; border-radius: 4px;">
                    <span class="material-symbols-outlined" style="font-size: 16px;">format_align_left</span>
                  </button>
                  <button (click)="block.data.align = 'center'" [class.active-ctrl]="block.data?.align === 'center' || !block.data?.align" title="Center" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer; border-radius: 4px;">
                    <span class="material-symbols-outlined" style="font-size: 16px;">format_align_center</span>
                  </button>
                  <button (click)="block.data.align = 'right'" [class.active-ctrl]="block.data?.align === 'right'" title="Align Right (Float)" [disabled]="block.data?.size === 'full'" [style.opacity]="block.data?.size === 'full' ? '0.5' : '1'" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; cursor: pointer; border-radius: 4px;">
                    <span class="material-symbols-outlined" style="font-size: 16px;">format_align_right</span>
                  </button>
                </div>
              </div>

              <!-- Floated Image Item -->
              <div [ngClass]="['img-size-' + (block.data?.size || 'full'), 'img-align-' + (block.data?.align || 'center')]" style="position: relative;">
                <img [src]="block.content" class="block-image-item riso-print" alt="Block image" style="width: 100%; height: auto; object-fit: contain; display: block;" />
                <button (click)="block.content = ''" class="btn-delete-image" style="z-index: 10;">
                  <span class="material-symbols-outlined text-[18px]">delete</span>
                </button>
              </div>

              <!-- Inline Text Editor wrapping around image -->
              <div style="overflow: hidden; display: block;">
                <textarea [(ngModel)]="block.data.text" 
                          placeholder="Escribe algo sobre la imagen... (opcional)" 
                          class="input-p" rows="3"
                          style="width: 100%; border: 1px dashed transparent; padding: 0.5rem; background: transparent; margin: 0; box-sizing: border-box; resize: vertical; display: block;"></textarea>
              </div>
            </div>
          </div>

          <!-- GALLERY BLOCK -->
          <div *ngSwitchCase="'gallery'" style="width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
              <span style="font-family: var(--font-mono); font-size: 0.75rem; font-weight: bold; color: var(--charcoal); text-transform: uppercase;">
                <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: text-bottom;">auto_awesome_mosaic</span>
                GALERÍA ({{ block.data?.images?.length || 0 }} imágenes)
              </span>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.4rem 0.75rem; border: 2px solid var(--charcoal); background: var(--accent-orange); color: white; font-family: var(--font-mono); font-size: 0.75rem; font-weight: bold;">
                <span class="material-symbols-outlined" style="font-size: 16px;">add_photo_alternate</span>
                AGREGAR
                <input type="file" multiple accept="image/*,.svg,.webp,.avif,.heic,.heif,.bmp,.tiff,.ico" (change)="onGalleryImagesSelected($event, block)" style="display: none;" />
              </label>
            </div>

            <!-- Empty State -->
            <div *ngIf="!block.data?.images?.length" style="border: 2px dashed #d1d5db; padding: 2rem; text-align: center; background: #f9fafb;">
              <span class="material-symbols-outlined" style="font-size: 48px; color: #9ca3af;">collections</span>
              <p style="font-family: var(--font-mono); font-size: 0.8rem; color: #6b7280; margin: 0.5rem 0 0;">
                Sube múltiples imágenes para crear una galería.<br/>Ideal para mockups, wireframes, y screenshots.
              </p>
            </div>

            <!-- Grid Preview -->
            <div *ngIf="block.data?.images?.length" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem;">
              <div *ngFor="let img of block.data.images; let imgIdx = index" style="position: relative; border: 2px solid var(--charcoal); overflow: hidden; aspect-ratio: 1; cursor: pointer;" (click)="openLightbox(img)">
                <img [src]="img" alt="Gallery item" style="width: 100%; height: 100%; object-fit: cover; display: block;" />
                <button (click)="removeGalleryImage(block, imgIdx); $event.stopPropagation()" style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); color: white; border: none; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 2px;">
                  <span class="material-symbols-outlined" style="font-size: 16px;">close</span>
                </button>
              </div>
            </div>
          </div>

          <div *ngSwitchCase="'code'" class="block-code-wrapper">
            <textarea [(ngModel)]="block.content" placeholder="// Write code here..." class="block-code-textarea" rows="4"></textarea>
          </div>

          <div *ngSwitchCase="'video'" class="block-video-wrapper">
            <!-- Empty state: source selector + input -->
            <div *ngIf="!block.content" class="block-video-empty">
              <span class="material-symbols-outlined block-video-icon">videocam</span>
              <div class="block-video-source-options">
                <label class="block-video-radio-label">
                  <input type="radio" [value]="'youtube'" [(ngModel)]="block.data.source" name="videoSource_{{block.id}}" />
                  <span class="block-video-radio-text">YouTube</span>
                </label>
                <label class="block-video-radio-label">
                  <input type="radio" [value]="'upload'" [(ngModel)]="block.data.source" name="videoSource_{{block.id}}" />
                  <span class="block-video-radio-text">Upload</span>
                </label>
              </div>
              <!-- YouTube URL input -->
              <div *ngIf="block.data.source === 'youtube'" class="block-video-url-wrapper">
                <input [(ngModel)]="block.content" class="block-video-url-input" placeholder="https://youtube.com/watch?v=..." (click)="$event.stopPropagation()" />
              </div>
              <!-- File upload -->
              <div *ngIf="block.data.source === 'upload'" class="block-video-upload-wrapper">
                <button (click)="videoFileInput.click()" class="btn-video-upload" [disabled]="isUploadingVideo">
                  <span *ngIf="!isUploadingVideo" style="display: flex; align-items: center; gap: 0.25rem;">
                    <span class="material-symbols-outlined text-[16px]">upload</span> SELECT VIDEO FILE
                  </span>
                  <span *ngIf="isUploadingVideo" style="display: flex; align-items: center; gap: 0.25rem; animation: pulse 2s infinite;">
                    <span class="material-symbols-outlined text-[16px]" style="animation: spin 1s linear infinite;">progress_activity</span> UPLOADING...
                  </span>
                </button>
                <input type="file" #videoFileInput (change)="onVideoFileSelected($event, block)" accept="video/*" class="hidden" style="display:none;" />
              </div>
            </div>
            <!-- Filled state: preview -->
            <div *ngIf="block.content" class="block-video-filled">
              <!-- YouTube embed -->
              <div *ngIf="isYoutubeUrl(block.content)" class="block-video-iframe-wrapper">
                <iframe [src]="getSafeVideoUrl(block.content)" class="block-video-iframe" frameborder="0" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
              </div>
              <!-- Direct video -->
              <div *ngIf="!isYoutubeUrl(block.content)" style="width: 100%;">
                <video [src]="block.content" controls class="block-video-direct-item"></video>
              </div>
              <button (click)="block.content = ''" class="btn-delete-image" style="z-index: 10;">
                <span class="material-symbols-outlined text-[18px]">delete</span>
              </button>
            </div>
          </div>

          <div *ngSwitchCase="'objective-header'" style="width: 100%; display: flex; flex-direction: column; gap: 1rem; padding: 0.5rem 0; border-bottom: 2px solid var(--charcoal);">
            <div style="display: flex; flex-wrap: wrap; align-items: center;">
              <input [(ngModel)]="block.data.title" placeholder="Main Title (e.g. 02_MISSION_OBJECTIVES)" class="input-obj-header-title" />
              <input [(ngModel)]="block.data.subtitle" placeholder="Subtitle (e.g. /TARGETS)" class="input-obj-header-subtitle" />
            </div>
          </div>

          <div *ngSwitchCase="'objectives'" class="block-objectives-wrapper">
             <div class="block-objectives-title">Objectives Grid</div>
             <div class="block-objectives-grid">
               <div *ngFor="let obj of block.data; let j = index" class="block-objective-card">
                 <input [(ngModel)]="obj.label" placeholder="OBJ_LABEL" class="input-obj-label" />
                 <input [(ngModel)]="obj.title" placeholder="Title" class="input-obj-title" />
                 <textarea [(ngModel)]="obj.desc" placeholder="Description" class="input-obj-desc" rows="3"></textarea>
                 <div class="obj-progress-row">
                   <span class="obj-progress-label">Progress %</span>
                   <input type="number" [(ngModel)]="obj.progress" class="input-obj-progress" />
                 </div>
               </div>
             </div>
          </div>

          <div *ngSwitchCase="'divider'" style="width: 100%; padding: 1rem; text-align: center; color: #9ca3af; font-family: var(--font-mono); font-size: 0.75rem; background-color: #f9fafb; border: 2px dashed #e5e7eb;">
            --- Divider (Sketch line) ---
          </div>


          <div *ngSwitchCase="'diagram'" class="diagram-container">
            
            <div class="diagram-header" style="justify-content: flex-start; gap: 1rem;">
              <span style="font-size: 0.75rem; opacity: 0.7;">ADD NODE:</span>
              
              <button *ngFor="let tpl of customNodeTemplates" (click)="addDiagramNode(block, tpl.id)" class="btn-toolbar-node" [title]="tpl.name">
                <span *ngIf="tpl.icon" class="material-symbols-outlined" style="font-size: 16px;">{{ tpl.icon }}</span>
                {{ tpl.name }}
              </button>
              <button (click)="addDiagramNode(block)" class="btn-toolbar-node" style="opacity: 0.6;">+ Blank</button>

              <div style="margin-left: auto; display: flex; align-items: center; gap: 0.25rem;">
                <span style="font-size: 0.7rem; opacity: 0.7; margin-right: 0.25rem;">SIZE:</span>
                
                <button (click)="block.data.size = 'small'; saveSnapshot()" 
                        class="btn-size" [class.active]="block.data.size === 'small'">S</button>
                
                <button (click)="block.data.size = 'medium'; saveSnapshot()" 
                        class="btn-size" [class.active]="block.data.size === 'medium'">M</button>
                
                <button (click)="block.data.size = 'large'; saveSnapshot()" 
                        class="btn-size" [class.active]="block.data.size === 'large' || !block.data.size">L</button>
                
                <span style="margin-left: 1rem; opacity: 0.5;">[SYSTEM_DIAGRAM]</span>
              </div>
            </div>

            <div class="foblex-canvas-wrapper" 
                 [ngClass]="'size-' + (block.data.size || 'large')">
              <f-flow fDraggable (fCreateConnection)="onConnectionCreated($event, block)">
                <f-canvas>
                  
                  <f-connection-for-create fBehavior="floating"></f-connection-for-create>

                  <f-connection *ngFor="let conn of block.data.connections"
                                [fOutputId]="conn.from"
                                [fInputId]="conn.to"
                                fBehavior="floating"
                                fType="straight">
                  </f-connection>

                  <div fNode *ngFor="let node of block.data.nodes"
                          [fNodePosition]="{x: node.x, y: node.y}"
                          (fNodePositionChange)="onNodeDrag($event, node)"
                          fDragHandle
                          class="brutalist-node-strict">

                    <div fNodeInput [fInputId]="node.id" fInputConnectableSide="left" class="f-port f-port-in"></div>

                    <span *ngIf="node.icon" class="material-symbols-outlined strict-icon">
                      {{ node.icon }}
                    </span>
                    
                    <input [(ngModel)]="node.text" 
                           (change)="saveSnapshot()" 
                           (keydown)="$event.stopPropagation()" 
                           class="strict-input" />

                    <button class="strict-delete-btn" (click)="removeDiagramNode(block, node.id)" title="Delete Node">
                      <span class="material-symbols-outlined" style="font-size: 14px; font-weight: bold;">close</span>
                    </button>

                    <div fNodeOutput [fOutputId]="node.id" fOutputConnectableSide="right" class="f-port f-port-out"></div>
                  </div>
                </f-canvas>
              </f-flow>
            </div>
          </div>

          <div *ngSwitchCase="'comparison'" class="comp-box">
            
            <div class="comp-header">
              <span class="material-symbols-outlined">compare_arrows</span>
              <span>COMPARISON_MATRIX</span>
            </div>

            <div class="comp-row comp-title-bg">
              <input [(ngModel)]="block.data.col1Title" (change)="saveSnapshot()" class="comp-input comp-title" placeholder="OPCIÓN A" />
              <div class="comp-vs">VS</div>
              <input [(ngModel)]="block.data.col2Title" (change)="saveSnapshot()" class="comp-input comp-title" placeholder="OPCIÓN B" />
            </div>

            <div class="comp-row" *ngFor="let row of block.data.rows; let i = index">
              <textarea [(ngModel)]="row.col1" (change)="saveSnapshot()" (input)="autoResize($any($event).target)" class="comp-input comp-text" rows="1" placeholder="Detalle de la opción A..."></textarea>
              
              <div class="comp-vs"></div>
              
              <textarea [(ngModel)]="row.col2" (change)="saveSnapshot()" (input)="autoResize($any($event).target)" class="comp-input comp-text" rows="1" placeholder="Detalle de la opción B..."></textarea>
              
              <button class="comp-delete" (click)="removeComparisonRow(block, i)">
                <span class="material-symbols-outlined" style="font-size:14px; font-weight:bold;">close</span>
              </button>
            </div>

            <button class="comp-add" (click)="addComparisonRow(block)">+ ADD ROW</button>
          </div>
        </ng-container>

        <div *ngIf="showSlashMenu && activeBlockIndex === i" class="slash-menu">
          <div class="slash-menu-header">Bloques Disponibles</div>
          <div *ngFor="let cmd of slashCommands; let ci = index"
               class="slash-menu-item"
               [class.slash-menu-item-active]="slashMenuSelectedIndex === ci"
               (click)="executeSlashCommand(cmd.type)"
               (mouseenter)="slashMenuSelectedIndex = ci">
            <span class="material-symbols-outlined text-[16px]">{{cmd.icon}}</span>
            <span>{{cmd.label}}</span>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div *ngIf="zenMode" class="zen-help-btn" (click)="toggleZenHelp()" title="Ver atajos de teclado">
  <span class="material-symbols-outlined">keyboard_command_key</span>
</div>

<div *ngIf="showZenHelp" class="brutalist-overlay" (click)="toggleZenHelp()">
  <div class="brutalist-modal cheat-sheet-modal" (click)="$event.stopPropagation()">
    
    <div class="modal-header" style="color: var(--charcoal, #1a1a1a);">
      <span class="material-symbols-outlined" style="font-size: 28px;">keyboard</span>
      MARKDOWN CHEAT SHEET
    </div>
    
    <div class="modal-body cheat-sheet-grid">
      <div class="cheat-row">
        <span class="key-badge">/</span> <span>Abre el Menú Mágico</span>
      </div>
      <div class="cheat-row">
        <span class="key-badge"># + Espacio</span> <span>Título 1 (H1)</span>
      </div>
      <div class="cheat-row">
        <span class="key-badge">## + Espacio</span> <span>Título 2 (H2)</span>
      </div>
      <div class="cheat-row">
        <span class="key-badge">---</span> <span>Línea Separadora</span>
      </div>
      <div class="cheat-row">
        <span class="key-badge">```</span> <span>Bloque de Código</span>
      </div>
      <div class="cheat-row">
        <span class="key-badge">> + Espacio</span> <span>Cabecera de Objetivo</span>
      </div>
      <div class="cheat-row" style="margin-top: 1rem; border-top: 2px dashed #e5e7eb; padding-top: 1rem;">
        <span class="key-badge">Ctrl + Z</span> <span>Deshacer (Máquina del tiempo)</span>
      </div>
    </div>
    
    <div class="modal-actions">
      <button (click)="toggleZenHelp()" class="btn-discard" style="width: 100%;">
        CLOSE / RETURN TO ZEN
      </button>
    </div>

  </div>
</div>

<div *ngIf="showToast" class="toast-container">
  <div class="brutalist-toast" [ngClass]="toastType === 'live' ? 'toast-live' : 'toast-draft'">
    
    <span class="material-symbols-outlined" style="font-size: 28px; font-weight: 900;">
      {{ toastType === 'live' ? 'rocket_launch' : 'edit_document' }}
    </span>
    
    <span>{{ toastMessage }}</span>

  </div>
</div>

<div *ngIf="showDraftModal" class="brutalist-overlay">
  <div class="brutalist-modal">
    
    <div class="modal-header">
      <span class="material-symbols-outlined" style="font-size: 28px;">warning</span>
      UNSAVED DRAFT DETECTED
    </div>
    
    <div class="modal-body">
      <p>System found an unsaved local draft for this entry.</p>
      <p>Do you want to recover your previous progress or start a completely fresh document?</p>
    </div>
    
    <div class="modal-actions">
      <button (click)="discardDraft()" class="btn-discard">
        START FRESH
      </button>
      
      <button (click)="acceptDraft()" class="btn-recover">
        RECOVER DRAFT
      </button>
    </div>

  </div>
</div>

<div *ngIf="isExiting" class="page-transition-curtain"></div>

<!-- Gallery Lightbox -->
<div *ngIf="lightboxImage" class="gallery-lightbox" (click)="closeLightbox()">
  <button class="lightbox-close" (click)="closeLightbox()">
    <span class="material-symbols-outlined">close</span>
  </button>
  <img [src]="lightboxImage" alt="Full size preview" class="lightbox-img" (click)="$event.stopPropagation()" />
</div>
