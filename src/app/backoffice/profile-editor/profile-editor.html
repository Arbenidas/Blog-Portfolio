<div class="profile-container">
    <div class="profile-header">
        <div>
            <h1 class="profile-title">Personnel Editor</h1>
            <p class="profile-subtitle">Manage Profile & Stickers</p>
        </div>
        <button [disabled]="isSaving()" (click)="save()" class="btn-publish-profile">
            <span class="material-symbols-outlined text-[16px]">{{ isSaving() ? 'hourglass_bottom' : 'save_as' }}</span>
            {{ isSaving() ? 'Saving...' : 'Publish Profile' }}
        </button>
    </div>

    <!-- MAIN SPLIT LAYOUT -->
    <div class="profile-layout">
        
        <!-- LEFT COLUMN: Data Entry & Sticker Drawer -->
        <div class="profile-sidebar custom-scrollbar">
            
            <!-- STICKERS DRAWER -->
            <div class="drawer-box group">
                <div class="drawer-overlay"></div>
                <h3 class="drawer-header">
                    <span>Available Stickers</span>
                    <span class="drawer-badge">DRAG TO PREVIEW</span>
                </h3>
                
                <div class="drawer-grid custom-scrollbar">
                    <div *ngFor="let widget of availableWidgets()" 
                         draggable="true" 
                         (dragstart)="onDragStart($event, widget)"
                         class="drawer-item">
                         <div class="drawer-item-scale" [innerHTML]="getSafeHtml(widget.html_content)"></div>
                         <div class="drawer-item-label">{{ widget.name }}</div>
                    </div>
                    <div *ngIf="availableWidgets().length === 0" class="drawer-empty-text">
                        No custom widgets found. Create them in Sticker Creator.
                    </div>
                </div>
            </div>

            <!-- PROFILE DATA FORM -->
            <div class="form-box">
                <!-- Basic Info -->
                <div class="form-section">
                    <h3 class="form-section-header">Identity File</h3>
                    <div class="form-grid-2">
                        <div class="form-field">
                            <label class="form-label">Code Name</label>
                            <input type="text" [(ngModel)]="profile().name" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Role</label>
                            <input type="text" [(ngModel)]="profile().role" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Location</label>
                            <input type="text" [(ngModel)]="profile().location" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Clearance Level</label>
                            <input type="text" [(ngModel)]="profile().clearance" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Status</label>
                            <input type="text" [(ngModel)]="profile().status" class="form-input">
                        </div>
                    </div>
                </div>

                <!-- Core Mission -->
                <div class="form-field">
                    <label class="form-label">Core Mission (HTML supported)</label>
                    <textarea [(ngModel)]="profile().coreMission" rows="4" class="form-textarea"></textarea>
                </div>

                <!-- Tech Stack -->
                <div class="form-section">
                    <h3 class="form-section-header">Capabilities</h3>
                    <div class="form-field">
                        <label class="form-label">Languages (comma separated)</label>
                        <input type="text" [(ngModel)]="languagesStr" (ngModelChange)="languagesStr=$event" class="form-input">
                    </div>
                    <div class="form-field">
                        <label class="form-label">Frameworks (comma separated)</label>
                        <input type="text" [(ngModel)]="frameworksStr" (ngModelChange)="frameworksStr=$event" class="form-input">
                    </div>
                </div>

                <!-- Deployment History -->
                <div class="form-section">
                    <div class="exp-header-row">
                        <h3 class="form-section-header" style="border-bottom: none; padding: 0;">Experience</h3>
                        <button (click)="addExperience()" class="btn-add-exp">+ ADD</button>
                    </div>
                    
                    <div *ngFor="let exp of profile().experience; let idx = index" class="exp-item group">
                        <button (click)="removeExperience(idx)" class="btn-remove-exp">
                            <span class="material-symbols-outlined text-[16px]">close</span>
                        </button>
                        <div class="exp-grid">
                            <input type="text" [(ngModel)]="exp.role" placeholder="Role" class="exp-input exp-input-bold">
                            <input type="text" [(ngModel)]="exp.company" placeholder="Company" class="exp-input">
                            <input type="text" [(ngModel)]="exp.location" placeholder="Location" class="exp-input">
                            <input type="text" [(ngModel)]="exp.years" placeholder="Years (e.g. 2021-Present)" class="exp-input">
                        </div>
                        <textarea [(ngModel)]="exp.description" placeholder="Description" rows="2" class="exp-textarea"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Live Render Canvas (Droppable) -->
        <div class="canvas-column">
            <div class="canvas-wrapper">
                <div class="canvas-header">
                    <div class="canvas-header-title">
                        <span class="canvas-pulse"></span> Preview Output
                    </div>
                    <span class="canvas-header-hint">Click a sticker to remove it</span>
                </div>
                
                <!-- The Canvas -->
                <div class="canvas-area custom-scrollbar"
                     (dragover)="onDragOver($event)"
                     (drop)="onDrop($event)">
                    
                    <!-- Inner Container simulating the exact Home screen width limits and scale -->
                    <div class="canvas-scaler">
                        
                        <!-- THE ACTUAL PROFILE TEMPLATE REPLICA -->
                        <div class="template-replica">
                            <div class="coffee-stain"></div>

                            <!-- Header -->
                            <div class="tpl-header">
                                <div class="tpl-classification">
                                    <span class="material-symbols-outlined text-[14px]">folder_special</span>
                                    Classification: Level 4
                                </div>
                                <h2 class="tpl-title">Personnel File</h2>
                                <div class="tpl-id-row">
                                    <span class="tpl-id-text">ID: ARBE_DEV_001</span>
                                    <div class="tpl-date-box">
                                        <span class="tpl-date-label">Date of Entry</span>
                                        <span class="tpl-date-val">24 OCT 2024</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 2 Column profile section -->
                            <div class="tpl-profile-section">
                                <div class="tpl-photo-col">
                                    <div class="tpl-photo-tape tape-strip"></div>
                                    <div class="tpl-photo-box">
                                        <img src="profile.jpg" class="tpl-photo-img">
                                        <div class="halftone-dots"></div>
                                        <div class="stamp-classified-wrapper">
                                            <span class="stamp-classified-text">CONFIDENTIAL</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="tpl-info-col">
                                    <div class="tpl-info-row">
                                        <span class="tpl-info-label">Name:</span>
                                        <span class="tpl-info-val">{{profile().name}}</span>
                                    </div>
                                    <div class="tpl-info-row">
                                        <span class="tpl-info-label">Role:</span>
                                        <span class="tpl-info-val">{{profile().role}}</span>
                                    </div>
                                    <div class="tpl-info-row">
                                        <span class="tpl-info-label">Location:</span>
                                        <span class="tpl-info-val">{{profile().location}}</span>
                                    </div>
                                    <div class="tpl-info-row">
                                        <span class="tpl-info-label">Clearance:</span>
                                        <span class="tpl-info-val-highlight">{{profile().clearance}}</span>
                                    </div>
                                    <div class="tpl-info-row-last">
                                        <span class="tpl-info-label">Status:</span>
                                        <span class="tpl-info-val" style="display: flex; align-items: center; gap: 0.5rem;"><span class="tpl-status-indicator"></span>{{profile().status}}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Core Mission -->
                            <div class="tpl-section">
                                <div class="tpl-section-header">
                                    <span class="tpl-num-badge">01</span>
                                    <h3 class="tpl-section-title">Core Mission</h3>
                                </div>
                                <p class="tpl-core-mission" [innerHTML]="getSafeHtml(profile().coreMission)">
                                </p>
                            </div>

                            <!-- Deployment History -->
                            <div class="tpl-section">
                                <div class="tpl-section-header tpl-section-header-mb-large">
                                    <span class="tpl-num-badge tpl-num-badge-alt">02</span>
                                    <h3 class="tpl-section-title">Deployment History</h3>
                                </div>
                                <div class="tpl-exp-list">
                                    <div class="tpl-exp-line"></div>
                                    <div *ngFor="let exp of profile().experience; let i = index" [ngClass]="i === 0 ? 'tpl-exp-item-first' : 'tpl-exp-item'">
                                        <div [ngClass]="i === 0 ? 'tpl-exp-dot-first' : 'tpl-exp-dot'"></div>
                                        <div [ngClass]="i === 0 ? 'tpl-exp-header-first' : 'tpl-exp-header'">
                                            <h4 class="tpl-exp-role" [class.tpl-exp-role-dimmed]="i !== 0">{{ exp.role }} @ {{ exp.company }}</h4>
                                            <span class="tpl-exp-location">{{ exp.location }}</span>
                                        </div>
                                        <p [ngClass]="i === 0 ? 'tpl-exp-years-first' : 'tpl-exp-years'">{{ exp.years }}</p>
                                        <p class="tpl-exp-desc">{{ exp.description }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Capabilities -->
                            <div class="tpl-section" style="margin-bottom: 1rem;">
                                <div class="tpl-section-header tpl-section-header-mb-large">
                                    <span class="tpl-num-badge tpl-num-badge-alt2">03</span>
                                    <h3 class="tpl-section-title">Verified Capabilities</h3>
                                </div>
                                <div class="tpl-cap-grid">
                                    <div class="tpl-cap-box-lang">
                                        <p class="tpl-cap-title-lang">Languages</p>
                                        <div class="tpl-cap-tags">
                                            <span *ngFor="let item of profile().languages" class="tpl-cap-tag">{{ item }}</span>
                                        </div>
                                    </div>
                                    <div class="tpl-cap-box-fw">
                                        <p class="tpl-cap-title-fw">Frameworks</p>
                                        <div class="tpl-cap-tags">
                                            <span *ngFor="let item of profile().frameworks" class="tpl-cap-tag">{{ item }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RENDER DRAGGED STICKERS OVERLAY -->
                            <div *ngFor="let w of profile().widgets; let i = index" 
                                 class="tpl-widget-layer group"
                                 title="Click to remove sticker"
                                 (click)="removePlacedWidget(i)"
                                 [style.left.px]="w.x" 
                                 [style.top.px]="w.y">
                                 <div [innerHTML]="getWidgetHtml(w.widgetId)" class="tpl-widget-inner"></div>
                                 <div class="btn-remove-widget">
                                     <span class="material-symbols-outlined text-[10px]">close</span>
                                 </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
