<div class="profile-container">

    <!-- ===== SAVE TOAST NOTIFICATION ===== -->
    <div *ngIf="saveToast()" class="profile-toast" [class.profile-toast-error]="saveToast() === 'error'">
        <span class="material-symbols-outlined profile-toast-icon">{{ saveToast() === 'success' ? 'check_circle' : 'error' }}</span>
        <div>
            <strong>{{ saveToast() === 'success' ? 'Profile Published' : 'Error Saving Profile' }}</strong>
            <p>{{ saveToast() === 'success' ? 'Personnel file is now live on the public site.' : 'Something went wrong. Check the console.' }}</p>
        </div>
    </div>

    <div class="profile-header">
        <div>
            <h1 class="profile-title">Personnel Editor</h1>
            <p class="profile-subtitle">Manage Profile &amp; Stickers</p>
        </div>
        <button [disabled]="isSaving()" (click)="save()" class="btn-publish-profile">
            <span class="material-symbols-outlined" style="font-size:16px;">{{ isSaving() ? 'hourglass_bottom' : 'save_as' }}</span>
            {{ isSaving() ? 'Saving...' : 'Publish Profile' }}
        </button>
    </div>

    <!-- MAIN SPLIT LAYOUT -->
    <div class="profile-layout">
        
        <!-- LEFT COLUMN: Data Entry & Sticker Drawer -->
        <div class="profile-sidebar custom-scrollbar">
            

            <!-- PROFILE DATA FORM -->
            <div class="form-box">
                <!-- Basic Info -->
                <div class="form-section">
                    <h3 class="form-section-header">Identity File</h3>

                    <!-- AVATAR UPLOAD -->
                    <div class="avatar-upload-section">
                        <div class="avatar-preview-box">
                            <img *ngIf="profile().avatar_url" [src]="profile().avatar_url" class="avatar-preview-img">
                            <span *ngIf="!profile().avatar_url" class="material-symbols-outlined avatar-placeholder-icon">person</span>
                        </div>
                        <div class="avatar-upload-controls">
                            <label class="btn-upload-avatar">
                                <span class="material-symbols-outlined" style="font-size: 14px;">upload</span>
                                {{ uploadingAvatar ? 'Uploading...' : 'Upload Photo' }}
                                <input type="file" accept="image/*" (change)="onAvatarFileSelected($event)" style="display:none;" [disabled]="uploadingAvatar">
                            </label>
                            <span class="avatar-hint">Used for comments & public profile. Max 2MB.</span>
                        </div>
                    </div>

                    <!-- NICKNAME -->
                    <div class="nickname-section">
                        <label class="form-label">Public Nickname <span class="nickname-hint">(shown on comments & publications)</span></label>
                        <div class="nickname-input-row">
                            <span class="nickname-at">@</span>
                            <input type="text" [(ngModel)]="nicknameInput" class="form-input nickname-input" placeholder="your_nickname" [disabled]="!canChangeNickname || nicknameSaving">
                            <button class="btn-change-nickname" 
                                    (click)="changeNickname()" 
                                    [disabled]="!canChangeNickname || nicknameSaving || nicknameInput.trim() === profile().username"
                                    *ngIf="canChangeNickname">
                                {{ nicknameSaving ? 'Saving...' : 'Change' }}
                            </button>
                        </div>
                        <span *ngIf="!canChangeNickname" class="nickname-cooldown">
                            <span class="material-symbols-outlined" style="font-size: 12px;">lock_clock</span>
                            Locked — you can change again in {{ daysUntilChange }} days
                        </span>
                        <span *ngIf="nicknameError" class="nickname-error">{{ nicknameError }}</span>
                    </div>

                    <!-- REAL NAME + FIELDS -->
                    <div class="form-grid-2">
                        <div class="form-field">
                            <label class="form-label">Full Name <span class="nickname-hint">(private, for Personnel File)</span></label>
                            <input type="text" [(ngModel)]="profile().name" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Role</label>
                            <input type="text" [(ngModel)]="profile().role" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Location</label>
                            <input type="text" [(ngModel)]="profile().location" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Clearance Level</label>
                            <input type="text" [(ngModel)]="profile().clearance" class="form-input">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Status</label>
                            <input type="text" [(ngModel)]="profile().status" class="form-input">
                        </div>
                    </div>
                </div>

                <!-- Core Mission -->
                <div class="form-field">
                    <label class="form-label">Core Mission (HTML supported)</label>
                    <textarea [(ngModel)]="profile().coreMission" rows="4" class="form-textarea"></textarea>
                </div>

                <div class="form-section">
                    <h3 class="form-section-header">Capabilities</h3>

                    <!-- Languages -->
                    <div class="form-field">
                        <label class="form-label">Languages</label>
                        <div class="tech-tags-wrapper">
                            <div *ngFor="let lang of profile().languages" class="tech-chip-group">
                                <span class="tech-tag" [class.tech-tag-active]="editingTech === lang">
                                    <span class="tech-chip-name" (click)="toggleEditTech(lang)">{{ lang.name }}</span>
                                    <span *ngIf="lang.description" class="tech-chip-has-desc" title="Has description">●</span>
                                    <button (click)="removeLanguage(lang)" class="tech-tag-remove" title="Remove">&times;</button>
                                </span>
                                <!-- Inline edit panel -->
                                <div *ngIf="editingTech === lang" class="tech-edit-panel">
                                    <div class="tech-edit-row">
                                        <label class="form-label">Description (shown on hover)</label>
                                        <textarea [(ngModel)]="lang.description" rows="2" class="form-textarea tech-edit-textarea"
                                                  placeholder="e.g. Used for backend services at scale..."></textarea>
                                    </div>
                                    <div class="tech-edit-row">
                                        <label class="form-label">Link to a Work/Log (optional)</label>
                                        <div class="tech-link-row">
                                            <select [(ngModel)]="lang.linkCategory" class="tech-link-select">
                                                <option value="">— No link —</option>
                                                <option value="work">Work</option>
                                                <option value="log">Log</option>
                                            </select>
                                            <input type="text" [(ngModel)]="lang.linkSlug"
                                                   placeholder="slug-del-proyecto" class="form-input tech-link-input"
                                                   [disabled]="!lang.linkCategory" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tech-add-row">
                            <input type="text" [(ngModel)]="newLangInput" (keyup.enter)="addLanguage()"
                                   placeholder="e.g. TypeScript" class="form-input tech-add-input" />
                            <button (click)="addLanguage()" class="btn-add-tech">+ Add</button>
                        </div>
                    </div>

                    <!-- Frameworks / Tools -->
                    <div class="form-field">
                        <label class="form-label">Frameworks / Tools</label>
                        <div class="tech-tags-wrapper">
                            <div *ngFor="let fw of profile().frameworks" class="tech-chip-group">
                                <span class="tech-tag tech-tag-fw" [class.tech-tag-active]="editingTech === fw">
                                    <span class="tech-chip-name" (click)="toggleEditTech(fw)">{{ fw.name }}</span>
                                    <span *ngIf="fw.description" class="tech-chip-has-desc tech-chip-has-desc-fw" title="Has description">●</span>
                                    <button (click)="removeFramework(fw)" class="tech-tag-remove" title="Remove">&times;</button>
                                </span>
                                <!-- Inline edit panel -->
                                <div *ngIf="editingTech === fw" class="tech-edit-panel tech-edit-panel-fw">
                                    <div class="tech-edit-row">
                                        <label class="form-label">Description (shown on hover)</label>
                                        <textarea [(ngModel)]="fw.description" rows="2" class="form-textarea tech-edit-textarea"
                                                  placeholder="e.g. Main framework for all frontend projects..."></textarea>
                                    </div>
                                    <div class="tech-edit-row">
                                        <label class="form-label">Link to a Work/Log (optional)</label>
                                        <div class="tech-link-row">
                                            <select [(ngModel)]="fw.linkCategory" class="tech-link-select">
                                                <option value="">— No link —</option>
                                                <option value="work">Work</option>
                                                <option value="log">Log</option>
                                            </select>
                                            <input type="text" [(ngModel)]="fw.linkSlug"
                                                   placeholder="slug-del-proyecto" class="form-input tech-link-input"
                                                   [disabled]="!fw.linkCategory" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tech-add-row">
                            <input type="text" [(ngModel)]="newFwInput" (keyup.enter)="addFramework()"
                                   placeholder="e.g. Angular" class="form-input tech-add-input" />
                            <button (click)="addFramework()" class="btn-add-tech btn-add-tech-fw">+ Add</button>
                        </div>
                    </div>

                    <!-- Technologies -->
                    <div class="form-field">
                        <label class="form-label">Technologies</label>
                        <div class="tech-tags-wrapper">
                            <div *ngFor="let tech of profile().technologies" class="tech-chip-group">
                                <span class="tech-tag tech-tag-tech" [class.tech-tag-active]="editingTech === tech">
                                    <span class="tech-chip-name" (click)="toggleEditTech(tech)">{{ tech.name }}</span>
                                    <span *ngIf="tech.description" class="tech-chip-has-desc tech-chip-has-desc-tech" title="Has description">●</span>
                                    <button (click)="removeTechnology(tech)" class="tech-tag-remove" title="Remove">&times;</button>
                                </span>
                                <!-- Inline edit panel -->
                                <div *ngIf="editingTech === tech" class="tech-edit-panel tech-edit-panel-tech">
                                    <div class="tech-edit-row">
                                        <label class="form-label">Description (shown on hover)</label>
                                        <textarea [(ngModel)]="tech.description" rows="2" class="form-textarea tech-edit-textarea"
                                                  placeholder="e.g. Containerization platform..."></textarea>
                                    </div>
                                    <div class="tech-edit-row">
                                        <label class="form-label">Link to a Work/Log (optional)</label>
                                        <div class="tech-link-row">
                                            <select [(ngModel)]="tech.linkCategory" class="tech-link-select">
                                                <option value="">— No link —</option>
                                                <option value="work">Work</option>
                                                <option value="log">Log</option>
                                            </select>
                                            <input type="text" [(ngModel)]="tech.linkSlug"
                                                   placeholder="slug-del-proyecto" class="form-input tech-link-input"
                                                   [disabled]="!tech.linkCategory" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tech-add-row">
                            <input type="text" [(ngModel)]="newTechInput" (keyup.enter)="addTechnology()"
                                   placeholder="e.g. Docker" class="form-input tech-add-input" />
                            <button (click)="addTechnology()" class="btn-add-tech btn-add-tech-tech">+ Add</button>
                        </div>
                    </div>

                </div>

                <!-- Deployment History -->
                <div class="form-section">
                    <div class="exp-header-row">
                        <h3 class="form-section-header" style="border-bottom: none; padding: 0;">Experience</h3>
                        <button (click)="addExperience()" class="btn-add-exp">+ ADD</button>
                    </div>
                    
                    <div *ngFor="let exp of profile().experience; let idx = index" class="exp-item group">
                        <button (click)="removeExperience(idx)" class="btn-remove-exp">
                            <span class="material-symbols-outlined text-[16px]">close</span>
                        </button>
                        <div class="exp-grid">
                            <input type="text" [(ngModel)]="exp.role" placeholder="Role" class="exp-input exp-input-bold">
                            <input type="text" [(ngModel)]="exp.company" placeholder="Company" class="exp-input">
                            <input type="text" [(ngModel)]="exp.location" placeholder="Location" class="exp-input">
                            <input type="text" [(ngModel)]="exp.years" placeholder="Years (e.g. 2021-Present)" class="exp-input">
                        </div>
                        <textarea [(ngModel)]="exp.description" placeholder="Description" rows="2" class="exp-textarea"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Live Render Canvas (Droppable) -->
        <div class="canvas-column">
            <div class="canvas-wrapper">
                <div class="canvas-header">
                    <div class="canvas-header-title">
                        <span class="canvas-pulse"></span> Preview Output
                    </div>
                    <span class="canvas-header-hint">Click a sticker to remove it</span>
                </div>
                
                <!-- The Canvas -->
                <div class="canvas-area custom-scrollbar">
                    <!-- Inner Container simulating the exact Home screen width limits and scale -->
                    <div class="canvas-scaler">
                        
                        <!-- THE ACTUAL PROFILE TEMPLATE REPLICA -->
                        <div class="template-replica">
                            <div class="coffee-stain"></div>

                            <!-- Header -->
                            <div class="tpl-header">
                                <div class="tpl-classification">
                                    <span class="material-symbols-outlined text-[14px]">folder_special</span>
                                    Classification: Level 4
                                </div>
                                <h2 class="tpl-title">Personnel File</h2>
                                <div class="tpl-id-row">
                                    <span class="tpl-id-text">ID: ARBE_DEV_001</span>
                                    <div class="tpl-date-box">
                                        <span class="tpl-date-label">Date of Entry</span>
                                        <span class="tpl-date-val">24 OCT 2024</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 2 Column profile section -->
                            <div class="tpl-profile-section">
                                <div class="tpl-photo-col">
                                    <div class="tpl-photo-tape tape-strip"></div>
                                    <div class="tpl-photo-box tpl-photo-uploadable" (click)="personnelPhotoInput.click()">
                                        <img [src]="profile().personnel_photo || 'profile.jpg'" class="tpl-photo-img">
                                        <div class="halftone-dots"></div>
                                        <div class="stamp-classified-wrapper">
                                            <span class="stamp-classified-text">CONFIDENTIAL</span>
                                        </div>
                                        <div class="tpl-photo-upload-overlay">
                                            <span class="material-symbols-outlined" style="font-size: 24px;">photo_camera</span>
                                            <span style="font-size: 8px;">CHANGE PHOTO</span>
                                        </div>
                                    </div>
                                    <input #personnelPhotoInput type="file" accept="image/*" (change)="onPersonnelPhotoSelected($event)" style="display:none;">
                                </div>
                                <div class="tpl-info-col">
                                    <div class="tpl-info-row">
                                        <span class="tpl-info-label">Name:</span>
                                        <span class="tpl-info-val">{{profile().name}}</span>
                                    </div>
                                    <div class="tpl-info-row">
                                        <span class="tpl-info-label">Role:</span>
                                        <span class="tpl-info-val">{{profile().role}}</span>
                                    </div>
                                    <div class="tpl-info-row">
                                        <span class="tpl-info-label">Location:</span>
                                        <span class="tpl-info-val">{{profile().location}}</span>
                                    </div>
                                    <div class="tpl-info-row">
                                        <span class="tpl-info-label">Clearance:</span>
                                        <span class="tpl-info-val-highlight">{{profile().clearance}}</span>
                                    </div>
                                    <div class="tpl-info-row-last">
                                        <span class="tpl-info-label">Status:</span>
                                        <span class="tpl-info-val" style="display: flex; align-items: center; gap: 0.5rem;"><span class="tpl-status-indicator"></span>{{profile().status}}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Core Mission -->
                            <div class="tpl-section">
                                <div class="tpl-section-header">
                                    <span class="tpl-num-badge">01</span>
                                    <h3 class="tpl-section-title">Core Mission</h3>
                                </div>
                                <p class="tpl-core-mission" [innerHTML]="getSafeHtml(profile().coreMission)">
                                </p>
                            </div>

                            <!-- Deployment History -->
                            <div class="tpl-section">
                                <div class="tpl-section-header tpl-section-header-mb-large">
                                    <span class="tpl-num-badge tpl-num-badge-alt">02</span>
                                    <h3 class="tpl-section-title">Deployment History</h3>
                                </div>
                                <div class="tpl-exp-list">
                                    <div class="tpl-exp-line"></div>
                                    <div *ngFor="let exp of profile().experience; let i = index" [ngClass]="i === 0 ? 'tpl-exp-item-first' : 'tpl-exp-item'">
                                        <div [ngClass]="i === 0 ? 'tpl-exp-dot-first' : 'tpl-exp-dot'"></div>
                                        <div [ngClass]="i === 0 ? 'tpl-exp-header-first' : 'tpl-exp-header'">
                                            <h4 class="tpl-exp-role" [class.tpl-exp-role-dimmed]="i !== 0">{{ exp.role }} @ {{ exp.company }}</h4>
                                            <span class="tpl-exp-location">{{ exp.location }}</span>
                                        </div>
                                        <p [ngClass]="i === 0 ? 'tpl-exp-years-first' : 'tpl-exp-years'">{{ exp.years }}</p>
                                        <p class="tpl-exp-desc">{{ exp.description }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Capabilities -->
                            <div class="tpl-section" style="margin-bottom: 1rem;">
                                <div class="tpl-section-header tpl-section-header-mb-large">
                                    <span class="tpl-num-badge tpl-num-badge-alt2">03</span>
                                    <h3 class="tpl-section-title">Verified Capabilities</h3>
                                </div>
                                <div class="tpl-cap-grid">
                                    <div class="tpl-cap-box-lang">
                                        <p class="tpl-cap-title-lang">Languages</p>
                                        <div class="tpl-cap-tags">
                                            <span *ngFor="let item of profile().languages" class="tpl-cap-tag">{{ item.name }}</span>
                                        </div>
                                    </div>
                                    <div class="tpl-cap-box-fw">
                                        <p class="tpl-cap-title-fw">Frameworks</p>
                                        <div class="tpl-cap-tags">
                                            <span *ngFor="let item of profile().frameworks" class="tpl-cap-tag">{{ item.name }}</span>
                                        </div>
                                    </div>
                                    <div class="tpl-cap-box-tech">
                                        <p class="tpl-cap-title-tech">Technologies</p>
                                        <div class="tpl-cap-tags">
                                            <span *ngFor="let item of profile().technologies" class="tpl-cap-tag">{{ item.name }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
