<div class="h-full flex flex-col pt-4">
    <div class="flex justify-between items-end mb-6 border-b-2 border-charcoal/20 pb-4 relative z-10 w-full">
        <div>
            <h1 class="text-3xl font-black text-charcoal uppercase tracking-tighter leading-none mb-1">Personnel Editor</h1>
            <p class="font-mono text-xs text-gray-500 uppercase tracking-widest font-bold">Manage Profile & Stickers</p>
        </div>
        <button [disabled]="isSaving()" (click)="save()" class="bg-accent-orange text-white font-mono text-[10px] font-bold uppercase px-6 py-3 border border-charcoal hover:bg-orange-600 transition-colors disabled:opacity-50 flex items-center gap-2 shadow-[4px_4px_0_#1a1a1a] hover:translate-y-1 hover:shadow-none cursor-pointer">
            <span class="material-symbols-outlined text-[16px]">{{ isSaving() ? 'hourglass_bottom' : 'save_as' }}</span>
            {{ isSaving() ? 'Saving...' : 'Publish Profile' }}
        </button>
    </div>

    <!-- MAIN SPLIT LAYOUT -->
    <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-[600px] overflow-hidden">
        
        <!-- LEFT COLUMN: Data Entry & Sticker Drawer -->
        <div class="lg:col-span-5 flex flex-col gap-6 h-full overflow-y-auto custom-scrollbar pb-10">
            
            <!-- STICKERS DRAWER -->
            <div class="bg-paper-cream border-2 border-charcoal p-4 shrink-0 shadow-sm relative overflow-hidden group">
                <div class="absolute inset-0 bg-transparent group-hover:bg-white/50 pointer-events-none transition-colors"></div>
                <h3 class="font-mono text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-3 border-b-2 border-dashed border-gray-400 pb-1 flex justify-between items-center relative z-10 w-full">
                    <span>Available Stickers</span>
                    <span class="text-[8px] bg-charcoal text-white px-2 py-0.5">DRAG TO PREVIEW</span>
                </h3>
                
                <div class="flex gap-4 overflow-x-auto pb-2 custom-scrollbar relative z-10 min-h-[80px]">
                    <div *ngFor="let widget of availableWidgets()" 
                         draggable="true" 
                         (dragstart)="onDragStart($event, widget)"
                         class="border-2 border-dashed border-charcoal hover:border-solid bg-white hover:bg-yellow-50 p-2 cursor-grab active:cursor-grabbing w-24 h-24 shrink-0 overflow-hidden flex flex-col items-center justify-center transform transition-all hover:scale-105 shadow-sm">
                         <div class="pointer-events-none transform scale-[0.3] origin-center w-[200px] h-full flex items-center justify-center" 
                              [innerHTML]="getSafeHtml(widget.html_content)"></div>
                         <div class="font-mono text-[8px] font-bold text-center mt-auto w-full truncate border-t border-dashed border-gray-200 pt-1 mt-1 shrink-0">{{ widget.name }}</div>
                    </div>
                    <div *ngIf="availableWidgets().length === 0" class="text-xs font-mono text-gray-400 py-4 px-2 italic">
                        No custom widgets found. Create them in Sticker Creator.
                    </div>
                </div>
            </div>

            <!-- PROFILE DATA FORM -->
            <div class="bg-white border-2 border-charcoal shadow-sketch p-6 space-y-6">
                <!-- Basic Info -->
                <div class="space-y-4">
                    <h3 class="font-display font-bold text-lg uppercase border-b-2 border-charcoal pb-1">Identity File</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-1">
                            <label class="font-mono text-[10px] font-bold text-gray-500 uppercase">Code Name</label>
                            <input type="text" [(ngModel)]="profile().name" class="border border-charcoal p-2 font-mono text-xs outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="font-mono text-[10px] font-bold text-gray-500 uppercase">Role</label>
                            <input type="text" [(ngModel)]="profile().role" class="border border-charcoal p-2 font-mono text-xs outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="font-mono text-[10px] font-bold text-gray-500 uppercase">Location</label>
                            <input type="text" [(ngModel)]="profile().location" class="border border-charcoal p-2 font-mono text-xs outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="font-mono text-[10px] font-bold text-gray-500 uppercase">Clearance Level</label>
                            <input type="text" [(ngModel)]="profile().clearance" class="border border-charcoal p-2 font-mono text-xs outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="font-mono text-[10px] font-bold text-gray-500 uppercase">Status</label>
                            <input type="text" [(ngModel)]="profile().status" class="border border-charcoal p-2 font-mono text-xs outline-none focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                </div>

                <!-- Core Mission -->
                <div class="flex flex-col gap-1">
                    <label class="font-mono text-[10px] font-bold text-gray-500 uppercase">Core Mission (HTML supported)</label>
                    <textarea [(ngModel)]="profile().coreMission" rows="4" class="border border-charcoal p-2 font-mono text-xs outline-none focus:ring-2 focus:ring-primary resize-y"></textarea>
                </div>

                <!-- Tech Stack -->
                <div class="space-y-4">
                    <h3 class="font-display font-bold text-lg uppercase border-b-2 border-charcoal pb-1">Capabilities</h3>
                    <div class="flex flex-col gap-1">
                        <label class="font-mono text-[10px] font-bold text-gray-500 uppercase">Languages (comma separated)</label>
                        <input type="text" [(ngModel)]="languagesStr" (ngModelChange)="languagesStr=$event" class="border border-charcoal p-2 font-mono text-xs outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="font-mono text-[10px] font-bold text-gray-500 uppercase">Frameworks (comma separated)</label>
                        <input type="text" [(ngModel)]="frameworksStr" (ngModelChange)="frameworksStr=$event" class="border border-charcoal p-2 font-mono text-xs outline-none focus:ring-2 focus:ring-primary">
                    </div>
                </div>

                <!-- Deployment History -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center border-b-2 border-charcoal pb-1">
                        <h3 class="font-display font-bold text-lg uppercase">Experience</h3>
                        <button (click)="addExperience()" class="font-mono text-[9px] font-bold bg-charcoal text-white px-2 py-1 hover:bg-primary transition-colors cursor-pointer">+ ADD</button>
                    </div>
                    
                    <div *ngFor="let exp of profile().experience; let idx = index" class="border-l-4 border-charcoal bg-gray-50 p-4 relative group">
                        <button (click)="removeExperience(idx)" class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                            <span class="material-symbols-outlined text-[16px]">close</span>
                        </button>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="text" [(ngModel)]="exp.role" placeholder="Role" class="border border-gray-300 p-1 text-[11px] font-bold">
                            <input type="text" [(ngModel)]="exp.company" placeholder="Company" class="border border-gray-300 p-1 text-[11px]">
                            <input type="text" [(ngModel)]="exp.location" placeholder="Location" class="border border-gray-300 p-1 text-[11px]">
                            <input type="text" [(ngModel)]="exp.years" placeholder="Years (e.g. 2021-Present)" class="border border-gray-300 p-1 text-[11px]">
                        </div>
                        <textarea [(ngModel)]="exp.description" placeholder="Description" rows="2" class="w-full border border-gray-300 p-1 text-[11px]"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Live Render Canvas (Droppable) -->
        <div class="lg:col-span-7 h-full flex flex-col min-h-[500px] overflow-hidden">
            <div class="bg-white border-2 border-charcoal flex-grow flex flex-col overflow-hidden">
                <div class="border-b-2 border-charcoal p-2 bg-gray-100 flex items-center justify-between shrink-0 shadow-[0_2px_4px_rgba(0,0,0,0.05)] relative z-20">
                    <div class="font-mono text-[10px] font-bold tracking-widest text-charcoal uppercase flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-accent-orange animate-pulse"></span> Preview Output
                    </div>
                    <span class="text-[9px] font-mono text-gray-500">Click a sticker to remove it</span>
                </div>
                
                <!-- The Canvas -->
                <div class="flex-grow bg-[#e5e7eb] relative overflow-auto p-4 custom-scrollbar lg:p-8 flex justify-center items-start"
                     (dragover)="onDragOver($event)"
                     (drop)="onDrop($event)">
                    
                    <!-- Inner Container simulating the exact Home screen width limits and scale -->
                    <div class="relative w-full max-w-[1000px] bg-transparent origin-top" style="transform: scale(0.85);">
                        
                        <!-- THE ACTUAL PROFILE TEMPLATE REPLICA -->
                        <div class="border-2 border-charcoal p-8 bg-[#fdfbf7] relative shadow-2xl" style="background-image: radial-gradient(#d1cfcb 1.5px, transparent 1px); background-size: 20px 20px;">
                            <div class="coffee-stain absolute -top-10 -right-10 w-48 h-48 opacity-20 rotate-45 pointer-events-none"></div>

                            <!-- Header -->
                            <div class="border-b-2 border-charcoal pb-4 mb-6 relative">
                                <div class="flex items-center gap-2 font-mono text-[10px] uppercase font-bold text-gray-700 mb-2">
                                    <span class="material-symbols-outlined text-[14px]">folder_special</span>
                                    Classification: Level 4
                                </div>
                                <h2 class="font-display font-black text-6xl text-charcoal uppercase tracking-tighter leading-none mb-2">Personnel File</h2>
                                <div class="flex justify-between items-end">
                                    <span class="font-mono font-bold text-accent-orange text-lg">ID: ARBE_DEV_001</span>
                                    <div class="border border-charcoal px-3 py-2 bg-white text-center shadow-sm">
                                        <span class="block font-mono text-[8px] text-gray-500 uppercase tracking-widest mb-1">Date of Entry</span>
                                        <span class="block font-mono text-xs font-bold text-charcoal">24 OCT 2024</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 2 Column profile section -->
                            <div class="grid grid-cols-12 gap-8 mb-10 items-start">
                                <div class="col-span-4 relative">
                                    <div class="tape-strip mx-auto mb-[-8px] relative z-20 w-8 blur-[0.5px]"></div>
                                    <div class="bg-white border-2 border-charcoal p-1 shadow-[4px_4px_0_#1a1a1a] relative overflow-hidden">
                                        <img src="https://lh3.googleusercontent.com/aida-public/AB6AXuDbIYgaJs1m9jk_zu8zPtNaU-OZWDz5QR9A4OvNYvJF4jbDR4p5nRTpw3N-6StxErCbt10dXYvoW7NExwvZEOHBmBJHn58TrBNagjNHJYCqVIGLxRB01ksKUnZQGijwmmt0Jct4NWwk7HmHME1PnzdeUZ2duv-F5V_o1z54gV6ddkaY5gO7eMTvu7dh-snRw_9eajSsrr9Uz5Gbb0uX-4MM4k_XELr2ApH9gyxjp3asYXcui9ahXHem-94DNg3uLZVMjrL2UcuZi40" class="w-full h-auto object-cover border border-charcoal grayscale sepia-[0.2]">
                                        <div class="absolute inset-0 halftone-dots mix-blend-overlay pointer-events-none opacity-40"></div>
                                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                                            <span class="font-mono font-black text-2xl text-red-600/70 border-4 border-red-600/70 px-4 py-1 stamp-classified mix-blend-multiply transform -rotate-12 bg-white/20">CONFIDENTIAL</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-span-8 font-mono text-xs font-bold w-full bg-[#fdfbf7]/80 backdrop-blur-sm self-stretch flex flex-col pt-2">
                                    <div class="border-b border-dashed border-gray-400 py-3 flex items-center"><span class="text-gray-500 w-28 opacity-80 uppercase tracking-widest">Name:</span><span class="text-charcoal uppercase text-sm">{{profile().name}}</span></div>
                                    <div class="border-b border-dashed border-gray-400 py-3 flex items-center"><span class="text-gray-500 w-28 opacity-80 uppercase tracking-widest">Role:</span><span class="text-charcoal uppercase text-sm">{{profile().role}}</span></div>
                                    <div class="border-b border-dashed border-gray-400 py-3 flex flex-wrap items-center"><span class="text-gray-500 w-28 opacity-80 uppercase tracking-widest">Location:</span><span class="text-charcoal uppercase text-sm">{{profile().location}}</span></div>
                                    <div class="border-b border-dashed border-gray-400 py-3 flex flex-wrap items-center"><span class="text-gray-500 w-28 opacity-80 uppercase tracking-widest">Clearance:</span><span class="text-green-700 font-bold uppercase text-sm drop-shadow-sm">{{profile().clearance}}</span></div>
                                    <div class="py-3 flex items-center"><span class="text-gray-500 w-28 opacity-80 uppercase tracking-widest">Status:</span><span class="text-charcoal uppercase flex items-center gap-2 text-sm"><span class="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse border border-green-600 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span>{{profile().status}}</span></div>
                                </div>
                            </div>

                            <!-- Core Mission -->
                            <div class="mb-10 relative">
                                <div class="flex items-center gap-3 border-b-2 border-charcoal pb-2 mb-4">
                                    <span class="bg-charcoal text-white font-mono text-[10px] font-bold px-2 py-1 transform -rotate-2">01</span>
                                    <h3 class="font-display font-bold text-xl uppercase tracking-tight text-charcoal">Core Mission</h3>
                                </div>
                                <p class="font-body text-charcoal text-[17px] leading-relaxed max-w-2xl bg-white/70 backdrop-blur-sm p-4 border border-dashed border-charcoal/20" [innerHTML]="getSafeHtml(profile().coreMission)">
                                </p>
                            </div>

                            <!-- Deployment History -->
                            <div class="mb-10">
                                <div class="flex items-center gap-3 border-b-2 border-charcoal pb-2 mb-8">
                                    <span class="bg-charcoal text-white font-mono text-[10px] font-bold px-2 py-1 transform rotate-1">02</span>
                                    <h3 class="font-display font-bold text-xl uppercase tracking-tight text-charcoal">Deployment History</h3>
                                </div>
                                <div class="relative pl-6 space-y-8 font-mono before:absolute before:left-[11px] before:top-2 before:bottom-2 before:w-[2px] before:bg-charcoal/20 before:border-l before:border-dashed before:border-charcoal/50">
                                    <div *ngFor="let exp of profile().experience; let i = index" class="relative {{ i === 0 ? 'bg-white p-4 border border-charcoal shadow-[2px_2px_0_#1a1a1a] transform rotate-[0.5deg]' : 'bg-white/50 p-4 border border-charcoal/30' }}">
                                        <div class="absolute -left-[30px] top-4 w-3.5 h-3.5 {{ i === 0 ? 'bg-charcoal' : 'bg-gray-300' }} rounded-full border-[3px] border-paper-cream z-10"></div>
                                        <div class="flex justify-between items-center mb-3 {{ i === 0 ? 'border-b border-gray-200' : 'border-b border-dashed border-gray-200' }} pb-2">
                                            <h4 class="font-bold text-[15px] text-charcoal uppercase {{ i !== 0 ? 'opacity-80' : '' }}">{{ exp.role }} @ {{ exp.company }}</h4>
                                            <span class="text-[10px] text-gray-500 tracking-tight uppercase font-bold">{{ exp.location }}</span>
                                        </div>
                                        <p class="text-[10px] {{ i === 0 ? 'text-accent-orange' : 'text-gray-500' }} uppercase tracking-widest font-bold mb-3">{{ exp.years }}</p>
                                        <p class="text-xs text-gray-600 leading-relaxed font-body">{{ exp.description }}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Capabilities -->
                            <div class="mb-4">
                                <div class="flex items-center gap-3 border-b-2 border-charcoal pb-2 mb-6">
                                    <span class="bg-charcoal text-white font-mono text-[10px] font-bold px-2 py-1 transform rotate-2">03</span>
                                    <h3 class="font-display font-bold text-xl uppercase tracking-tight text-charcoal">Verified Capabilities</h3>
                                </div>
                                <div class="grid grid-cols-2 gap-6">
                                    <div class="bg-white border-2 border-charcoal p-5 relative shadow-[4px_4px_0_#e5e7eb] transform -rotate-1">
                                        <p class="font-mono text-[10px] text-accent-orange font-bold uppercase tracking-widest mb-4 border-b border-gray-200 pb-2">Languages</p>
                                        <div class="flex flex-wrap gap-2 font-mono text-xs font-bold text-charcoal">
                                            <span *ngFor="let item of profile().languages" class="bg-gray-100 px-3 py-1.5 border border-charcoal shadow-sm">{{ item }}</span>
                                        </div>
                                    </div>
                                    <div class="bg-white border-2 border-charcoal p-5 relative shadow-[4px_4px_0_#e5e7eb] transform rotate-1">
                                        <p class="font-mono text-[10px] text-primary font-bold uppercase tracking-widest mb-4 border-b border-gray-200 pb-2">Frameworks</p>
                                        <div class="flex flex-wrap gap-2 font-mono text-xs font-bold text-charcoal">
                                            <span *ngFor="let item of profile().frameworks" class="bg-gray-100 px-3 py-1.5 border border-charcoal shadow-sm">{{ item }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RENDER DRAGGED STICKERS OVERLAY -->
                            <div *ngFor="let w of profile().widgets; let i = index" 
                                 class="absolute z-50 cursor-pointer group"
                                 title="Click to remove sticker"
                                 (click)="removePlacedWidget(i)"
                                 [style.left.px]="w.x" 
                                 [style.top.px]="w.y">
                                 <div [innerHTML]="getWidgetHtml(w.widgetId)" class="pointer-events-none group-hover:scale-95 group-hover:opacity-75 transition-all"></div>
                                 <div class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center opacity-0 group-hover:opacity-100 shadow-lg">
                                     <span class="material-symbols-outlined text-[10px]">close</span>
                                 </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
