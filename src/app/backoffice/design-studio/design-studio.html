<div class="design-studio-container">
  <!-- === HEADER === -->
  <div class="ds-header">
    <div>
      <h1 class="ds-title">Design_Studio</h1>
      <p class="ds-subtitle">CREATE STICKERS & DIAGRAM NODES // MINI_FIGMA_PROTOCOL</p>
    </div>
  </div>

  <!-- === MODE TOGGLE === -->
  <div class="ds-mode-toggle">
    <button (click)="setMode('sticker')"
      [class]="mode() === 'sticker' ? 'btn-mode-active' : 'btn-mode-inactive'"
      class="btn-mode">
      <span class="material-symbols-outlined btn-mode-icon">sticky_note_2</span>
      Sticker
    </button>
    <button (click)="setMode('node')"
      [class]="mode() === 'node' ? 'btn-mode-active' : 'btn-mode-inactive btn-mode-border-l'"
      class="btn-mode">
      <span class="material-symbols-outlined btn-mode-icon">account_tree</span>
      Diagram Node
    </button>
  </div>

  <div class="ds-grid">
    <!-- ==================== -->
    <!-- LEFT: EDITOR PANEL   -->
    <!-- ==================== -->
    <div class="ds-panel-left">
      <div class="ds-panel-box">
        <div class="tape-strip" style="top: -15px; left: 20%; transform: rotate(-3deg);"></div>

        <!-- Header Bar -->
        <div class="ds-panel-header">
          <div class="ds-panel-title-group">
            <span class="material-symbols-outlined ds-panel-title-icon">{{ mode() === 'sticker' ? 'sticky_note_2' : 'account_tree' }}</span>
            <h2 class="ds-panel-title">
              {{ mode() === 'sticker' ? 'Sticker_Workbench' : 'Node_Workbench' }}
            </h2>
          </div>
          <span class="ds-panel-badge">LIVE_PREVIEW</span>
        </div>

        <!-- =============================== -->
        <!-- STICKER MODE EDITOR             -->
        <!-- =============================== -->
        <div *ngIf="mode() === 'sticker'" class="ds-editor-content">
          <div class="ds-form-group">
            <label class="ds-label">Sticker Name</label>
            <input [(ngModel)]="editingWidget().name" class="ds-input" placeholder="e.g. Draft Tag" type="text" />
          </div>

          <div class="ds-form-group">
            <label class="ds-label">HTML / CSS Content</label>
            <textarea [(ngModel)]="editingWidget().html_content" class="ds-textarea" rows="8" placeholder='<div style="...">Your Sticker</div>'></textarea>
          </div>

          <!-- Sticker Live Preview -->
          <div class="ds-form-group">
            <label class="ds-label">Preview</label>
            <div class="ds-preview-box">
              <div [innerHTML]="getSafeHtml(editingWidget().html_content)"></div>
            </div>
          </div>

          <div class="ds-actions">
            <button (click)="saveSticker()" [disabled]="isSaving()" class="btn-save">
              <span class="material-symbols-outlined" style="font-size: 18px;">save</span>
              {{ isSaving() ? 'Saving...' : 'Save Sticker' }}
            </button>
            <button (click)="createNewSticker()" class="btn-reset">
              Reset
            </button>
          </div>
        </div>

        <!-- =============================== -->
        <!-- NODE MODE EDITOR                -->
        <!-- =============================== -->
        <div *ngIf="mode() === 'node'" class="ds-editor-content">
          <!-- Node Name -->
          <div class="ds-form-group">
            <label class="ds-label">Node Name / Label</label>
            <input [(ngModel)]="nodeName" class="ds-input" placeholder="e.g. Postgres Cluster" type="text" />
          </div>

          <!-- Shape -->
          <div class="ds-form-group">
            <label class="ds-label ds-label-mb">Shape</label>
            <div class="ds-btn-group">
              <button *ngFor="let s of shapes" (click)="selectedShape = s.id"
                [class]="selectedShape === s.id ? 'btn-shape-active' : 'btn-shape-inactive'"
                class="btn-shape">
                <span class="material-symbols-outlined" style="font-size: 16px;">{{ s.icon }}</span>
                {{ s.label }}
              </button>
            </div>
          </div>

          <!-- Background Color -->
          <div class="ds-form-group">
            <label class="ds-label ds-label-mb">Background</label>
            <div class="ds-btn-group">
              <button *ngFor="let c of bgColors" (click)="selectedBg = c.id"
                [class]="selectedBg === c.id ? 'btn-color-active' : ''"
                class="btn-color"
                [style.background-color]="c.preview"
                [title]="c.label">
              </button>
            </div>
          </div>

          <!-- Text Color -->
          <div class="ds-form-group">
            <label class="ds-label ds-label-mb">Text Color</label>
            <div class="ds-btn-group">
              <button *ngFor="let tc of textColors" (click)="selectedText = tc.id"
                [class]="selectedText === tc.id ? 'btn-color-active' : ''"
                class="btn-text-color"
                [style.background-color]="tc.preview"
                [title]="tc.label">
                A
              </button>
            </div>
          </div>

          <!-- Border -->
          <div class="ds-form-group">
            <label class="ds-label ds-label-mb">Border</label>
            <div class="ds-btn-group">
              <button *ngFor="let b of borders" (click)="selectedBorder = b.id"
                [class]="selectedBorder === b.id ? 'btn-border-active' : 'btn-border-inactive'"
                class="btn-border">
                {{ b.label }}
              </button>
            </div>
          </div>

          <!-- Shadow -->
          <div class="ds-form-group">
            <label class="ds-label ds-label-mb">Shadow</label>
            <div class="ds-btn-group">
              <button *ngFor="let sh of shadows" (click)="selectedShadow = sh.id"
                [class]="selectedShadow === sh.id ? 'btn-border-active' : 'btn-border-inactive'"
                class="btn-border">
                {{ sh.label }}
              </button>
            </div>
          </div>

          <!-- Typography -->
          <div class="ds-form-group">
            <label class="ds-label ds-label-mb">Typography</label>
            <div class="ds-btn-group">
              <button *ngFor="let f of fonts" (click)="selectedFont = f.id"
                [class]="selectedFont === f.id ? 'btn-font-active' : 'btn-font-inactive'"
                class="btn-font"
                [style.font-family]="f.family">
                {{ f.label }}
              </button>
            </div>
          </div>

          <!-- Icon Gallery -->
          <div class="ds-form-group">
            <label class="ds-label">Icon (click to select)</label>
            <div class="ds-icon-input-group">
              <input [(ngModel)]="nodeIcon" class="ds-input" style="flex-grow: 1;" placeholder="Type or pick below..." type="text" />
              <span *ngIf="nodeIcon" class="material-symbols-outlined" style="font-size: 30px; color: var(--charcoal);">{{ nodeIcon }}</span>
              <button *ngIf="nodeIcon" (click)="nodeIcon = ''" class="btn-icon-clear">
                <span class="material-symbols-outlined" style="font-size: 18px;">close</span>
              </button>
            </div>
            <div class="ds-icon-grid">
              <button *ngFor="let ic of popularIcons" (click)="nodeIcon = ic"
                [class]="nodeIcon === ic ? 'btn-icon-grid-active' : 'btn-icon-grid-inactive'"
                class="btn-icon-grid"
                [title]="ic">
                <span class="material-symbols-outlined" style="font-size: 18px;">{{ ic }}</span>
              </button>
            </div>
          </div>

          <!-- =========================== -->
          <!--    LIVE NODE PREVIEW         -->
          <!-- =========================== -->
          <div class="ds-form-group">
            <label class="ds-label ds-label-mb">Live Preview</label>
            <div class="ds-preview-node-box">
              <div class="ds-node-preview-item"
                [ngStyle]="getNodePreviewStyle()">
                <span *ngIf="nodeIcon" class="material-symbols-outlined ds-node-preview-icon" [style.font-size]="selectedShape === 'circle' ? '24px' : '28px'">{{ nodeIcon }}</span>
                <span class="ds-node-preview-label" [class.ds-node-preview-label-lg]="selectedShape === 'text'">
                  {{ nodeName || 'Node Label' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Save / Reset -->
          <div class="ds-actions">
            <button (click)="saveNode()" [disabled]="isSaving() || !nodeName" class="btn-save">
              <span class="material-symbols-outlined" style="font-size: 18px;">save</span>
              {{ isSaving() ? 'Saving...' : 'Save Node Protocol' }}
            </button>
            <button (click)="resetNode()" class="btn-reset">
              Reset
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== -->
    <!-- RIGHT: SAVED ITEMS   -->
    <!-- ==================== -->
    <div class="ds-panel-right">
      <div class="ds-panel-box ds-panel-box-right">
        <div class="ds-panel-header">
          <h3 class="ds-panel-subtitle">
            {{ mode() === 'sticker' ? 'Saved Stickers' : 'Saved Nodes' }}
          </h3>
          <span class="ds-panel-meta">
            {{ mode() === 'sticker' ? widgets().length : nodes().length }} ITEMS
          </span>
        </div>

        <!-- STICKER LIST -->
        <div *ngIf="mode() === 'sticker'" class="ds-list-container">
          <div *ngIf="widgets().length === 0" class="ds-list-empty">
            NO_STICKERS_FOUND
          </div>
          <div *ngFor="let w of widgets()" class="ds-list-item group">
            <div class="ds-list-item-header">
              <span class="ds-list-item-title">{{ w.name }}</span>
              <div class="ds-list-item-actions">
                <button (click)="editSticker(w)" class="btn-list-action btn-list-action-edit">
                  <span class="material-symbols-outlined" style="font-size: 16px;">edit</span>
                </button>
                <button (click)="deleteSticker(w.id!)" class="btn-list-action btn-list-action-delete">
                  <span class="material-symbols-outlined" style="font-size: 16px;">delete</span>
                </button>
              </div>
            </div>
            <div class="ds-sticker-preview-sm" [innerHTML]="getSafeHtml(w.html_content)"></div>
          </div>
        </div>

        <!-- NODE LIST -->
        <div *ngIf="mode() === 'node'" class="ds-list-container">
          <div *ngIf="nodes().length === 0" class="ds-list-empty">
            NO_NODES_FOUND
          </div>
          <div *ngFor="let n of nodes()" class="ds-list-item ds-node-preview-sm-container group">
            <!-- Mini preview swatch -->
            <div class="ds-node-preview-sm"
              [style.background-color]="getBgPreview(n.bg_color)"
              [style.border-radius]="n.shape === 'circle' ? '50%' : '0'">
              <span *ngIf="n.icon" class="material-symbols-outlined" style="font-size: 16px;" [style.color]="getTextPreview(n.text_color)">{{ n.icon }}</span>
            </div>
            <div class="ds-node-info-sm">
              <span class="ds-node-title-sm">{{ n.name }}</span>
              <span class="ds-node-shape-sm">{{ n.shape | uppercase }}</span>
            </div>
            <div class="ds-list-item-actions shrink-0">
              <button (click)="editNode(n)" class="btn-list-action btn-list-action-edit">
                <span class="material-symbols-outlined" style="font-size: 16px;">edit</span>
              </button>
              <button (click)="deleteNode(n.id!)" class="btn-list-action btn-list-action-delete">
                <span class="material-symbols-outlined" style="font-size: 16px;">delete</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
