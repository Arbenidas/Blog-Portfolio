<!-- LOADING SKELETON -->
<main *ngIf="isLoading" class="case-study-main">
  <div class="case-study-nav">
     <div style="width: 120px; height: 20px; background-color: #e5e7eb; animation: pulse 2s infinite;"></div>
  </div>
  <div class="article-container" style="opacity: 0.7; animation: pulse 2s infinite;">
     <div class="article-inner" style="padding: 0;">
        <div class="hero-image-wrapper" style="background-color: #e5e7eb; height: 50vh; width: 100%;"></div>
        <div style="padding: 2.5rem;">
           <div style="height: 48px; background-color: #d1d5db; width: 60%; margin-bottom: 1rem;"></div>
           <div style="height: 24px; background-color: #e5e7eb; width: 40%; margin-bottom: 3rem;"></div>
           <div style="height: 16px; background-color: #e5e7eb; width: 100%; margin-bottom: 0.5rem;"></div>
           <div style="height: 16px; background-color: #e5e7eb; width: 100%; margin-bottom: 0.5rem;"></div>
           <div style="height: 16px; background-color: #e5e7eb; width: 80%;"></div>
        </div>
     </div>
  </div>
</main>

<main *ngIf="work && !isLoading" class="case-study-main fade-in-up">
  <div class="fixed inset-0 z-0 bg-halftone opacity-10 pointer-events-none" style="background-size: 8px 8px;"></div>
  <div class="coffee-stain" style="top: 2.5rem; right: 5rem; opacity: 0.4; transform: scale(1.5) rotate(90deg);"></div>

  <!-- FLUID WIDGET LAYER (Outside the white paper) -->
  <div class="absolute inset-0 pointer-events-none z-50 overflow-visible hidden md:block">
    <ng-container *ngFor="let widget of work.blocks">
      <div *ngIf="widget.type === 'widget'" class="absolute pointer-events-auto" [style.transform]="'translate3d(' + (widget.data?.x || 0) + 'px, ' + (widget.data?.y || 0) + 'px, 0)'">
         
         <ng-container>
            <div class="pointer-events-none" [innerHTML]="getWidgetHtml(widget.content)"></div>
         </ng-container>

      </div>
    </ng-container>
  </div>

  <!-- BACK NAV -->
  <div class="case-study-nav">
    <a class="btn-back-nav" routerLink="/works">
      <span class="material-symbols-outlined" style="font-size: 16px;">keyboard_return</span>
      RETURN_TO_DB
    </a>
    
    <div style="text-align: right;">
      <span class="classification-label">CLASSIFICATION_LEVEL</span>
      <span class="classification-badge">PUBLIC</span>
    </div>
  </div>

  <article class="article-container">
    <div class="article-inner">
      
      <!-- HERO SECTION -->
      <section class="hero-section">
        <div class="hero-ref-badge">REF_ID: {{ (work.id || 'PREVIEW').slice(0, 5) | uppercase }}</div>
        
        <div class="hero-image-wrapper">
          <div class="halftone-dots" style="position: absolute; inset: 0; opacity: 0.4; pointer-events: none; z-index: 10;"></div>
          
          <img *ngIf="work.coverPhoto" [src]="work.coverPhoto" class="hero-image" />
          <img *ngIf="!work.coverPhoto && work.blocks.length > 1 && work.blocks[1].type === 'image'" [src]="work.blocks[1].content" class="hero-image" />
          <div *ngIf="!work.coverPhoto && (!work.blocks[1] || work.blocks[1].type !== 'image')" class="hero-no-image">
            <span class="material-symbols-outlined" style="font-size: 8rem;">image</span>
          </div>

          <div class="hero-date-box">
            <div style="text-align: center; padding: 0 0.5rem;">
              <span class="hero-date-label">DATE</span>
              <span class="hero-date-val">{{ work.createdAt | date:'MM.yyyy' }}</span>
            </div>
          </div>
        </div>

        <div class="hero-title-box">
          <div class="tape-strip" style="top: -15px; left: 2.5rem; transform: rotate(-3deg);"></div>
          
          <div class="hero-title-inner">
            <h1 class="hero-title">
              {{ work.title }}
            </h1>
            <br>
            <p class="hero-subtitle">
              {{ work.blocks.length > 0 && work.blocks[0].type === 'p' ? work.blocks[0].content : 'Case study data record.' }}
            </p>
          </div>
        </div>
      </section>

      <!-- DATA MATRIX -->
      <section class="data-matrix">
        <div class="data-cell-1">
          <h3 class="data-cell-title data-cell-title-orange">
            <span class="material-symbols-outlined data-cell-icon">build</span> Tech_Stack / Tags
          </h3>
          <div class="tech-tags-container">
            <span *ngFor="let tag of work.tags; let ti = index" 
              class="stamp-tech"
              [ngClass]="'stamp-tech-color-' + (ti % 5)">{{ tag }}</span>
            <span *ngIf="work.tags.length === 0" style="font-family: var(--font-mono); font-size: 0.875rem;">No tags provided</span>
          </div>
        </div>
        <div class="data-cell-2">
          <div style="position: absolute; right: -1rem; bottom: -1rem; opacity: 0.1;">
            <span class="material-symbols-outlined " style="font-size: 150px;">my_location</span>
          </div>
          <h3 class="data-cell-title data-cell-title-charcoal">
            <span class="material-symbols-outlined data-cell-icon">info</span> Meta
          </h3>
          <ul class="meta-list">
            <li>&gt; Created: {{ work.createdAt | date:'medium' }}</li>
            <li>&gt; Updated: {{ work.updatedAt | date:'medium' }}</li>
          </ul>
        </div>
      </section>

      <!-- MAIN CONTENT AREA -->
      <section class="content-section">
        
        <!-- INDEX LOG SIDEBAR (if present) -->
        <aside *ngIf="work.indexLog" class="index-sidebar">
          <div class="index-box">
             <div class="index-box-bg"></div>
             
             <h3 class="index-title">INDEX_LOG</h3>
             <ul class="index-list">
                 <li *ngFor="let item of work.indexLog.split('\n'); let ij = index" class="index-item">
                   <div class="index-dot" [ngClass]="ij === 0 ? 'index-dot-orange' : 'index-dot-charcoal'"></div>
                   {{ item.trim() | uppercase }}
                 </li>
             </ul>
             
             <div class="index-divider"></div>
             
             <button class="btn-download-pdf mt-6">
               DOWNLOAD PDF
             </button>
          </div>
        </aside>

        <!-- Dynamic Content Blocks -->
        <div class="dynamic-blocks-container">
          <ng-container *ngFor="let block of work.blocks; let i = index">
          
          <div *ngIf="block.type === 'h1'" class="block-h1-container">
            <h2 class="block-h1-title">{{ block.content }}_</h2>
          </div>

          <div *ngIf="block.type === 'h2'" class="block-h2-container">
            <h3 class="block-h2-title">{{ block.content }}_</h3>
          </div>

          <div *ngIf="block.type === 'p'" class="block-p-container">
            <p class="block-p-text">{{ block.content }}</p>
          </div>

          <div *ngIf="block.type === 'image'" class="block-image-container">
            <div class="block-image-box">
              <div class="block-image-label">FIG.{{ i }} : ARCHIVE_IMG</div>
              <img [src]="block.content" class="block-image-img">
            </div>
          </div>

          <div *ngIf="block.type === 'video'" class="block-video-container">
            <div class="block-video-box">
              <div class="block-image-label">FIG.{{ i }} : ARCHIVE_VID</div>
              <!-- YouTube embed -->
              <div *ngIf="isYoutubeUrl(block.content)" class="block-video-embed">
                <iframe [src]="getSafeVideoUrl(block.content)" style="width: 100%; height: 100%;" frameborder="0" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
              </div>
              <!-- Direct video -->
              <div *ngIf="!isYoutubeUrl(block.content)">
                <video [src]="block.content" controls class="block-video-direct"></video>
              </div>
            </div>
          </div>

          <div *ngIf="block.type === 'code'" class="block-code-container">
            <div class="block-code-box">
              <div class="block-code-header">
                <span>&gt; SYSTEM_LOG</span>
              </div>
              <pre class="block-code-pre"><code>{{ block.content }}</code></pre>
            </div>
          </div>

          <div *ngIf="block.type === 'objective-header'" class="block-obj-header-container">
            <h2 class="block-obj-title">{{ block.data?.title }}</h2>
            <span class="block-obj-subtitle">{{ block.data?.subtitle }}</span>
          </div>

          <div *ngIf="block.type === 'objectives'" style="width: 100%;">
            <div class="block-obj-grid">
              <div *ngFor="let obj of block.data" class="block-obj-card">
                <div class="block-obj-label">
                  {{ obj.label }}
                </div>
                <h3 class="block-obj-item-title">{{ obj.title }}</h3>
                <p class="block-obj-desc">{{ obj.desc }}</p>
                <div style="margin-top: auto;">
                  <div class="block-obj-progress-bg">
                    <div class="block-obj-progress-fill" [ngClass]="obj.progress > 50 ? 'block-obj-progress-high' : 'block-obj-progress-low'" [style.width.%]="obj.progress"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="block.type === 'divider'" class="block-divider-container">
            <div class="block-divider-1"></div>
            <div class="block-divider-2"></div>
          </div>

          <!-- tech-stack block is now rendered as fixed meta in the header, skip here -->

          <div *ngIf="block.type === 'diagram'" class="block-diagram-container">
            <div class="block-diagram-box">
              <div class="block-diagram-confidential">
                <span class="block-diagram-confidential-text">CONFIDENTIAL // INTERNAL USE ONLY</span>
              </div>
              
              <div class="block-diagram-canvas">

                <!-- SVG Arrow Overlay -->
                <svg style="position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
                  <defs>
                    <marker id="pub-arrowhead-solid" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto"><polygon points="0 0, 12 4, 0 8" fill="#1a1a1a" /></marker>
                    <marker id="pub-arrowhead-dashed" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto"><polygon points="0 0, 12 4, 0 8" fill="#1a1a1a" /></marker>
                    <marker id="pub-arrowhead-zigzag" markerWidth="14" markerHeight="10" refX="12" refY="5" orient="auto"><polygon points="0 0, 14 5, 0 10" fill="#d94e1e" /></marker>
                    <marker id="pub-arrowhead-graffiti" markerWidth="16" markerHeight="12" refX="14" refY="6" orient="auto"><circle cx="8" cy="6" r="5" fill="#1a1a1a" opacity="0.7" /></marker>
                    <marker id="pub-arrowhead-dotted" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto"><circle cx="5" cy="5" r="4" fill="#1a1a1a" /></marker>
                  </defs>
                  <ng-container *ngFor="let arrow of block.data?.arrows">
                    <line
                      [attr.x1]="getNodeEdgePoint(block, arrow.from, arrow.to).x"
                      [attr.y1]="getNodeEdgePoint(block, arrow.from, arrow.to).y"
                      [attr.x2]="getNodeEdgePoint(block, arrow.to, arrow.from).x"
                      [attr.y2]="getNodeEdgePoint(block, arrow.to, arrow.from).y"
                      [attr.stroke]="arrow.type === 'zigzag' ? '#d94e1e' : '#1a1a1a'"
                      [attr.stroke-width]="getArrowStrokeWidth(arrow.type)"
                      [attr.stroke-dasharray]="getArrowDashArray(arrow.type) === 'none' ? null : getArrowDashArray(arrow.type)"
                      [attr.marker-end]="getMarkerUrl(arrow.type)"
                      [attr.opacity]="arrow.type === 'graffiti' ? 0.6 : 1"
                      stroke-linecap="round"
                    />
                  </ng-container>
                </svg>

                 <div *ngFor="let node of block.data?.nodes; let ni = index" 
                      class="diagram-node"
                      [style.left.px]="node.x" [style.top.px]="node.y">
                      
                      <div *ngIf="node.type === 'postgres'" class="diagram-node-postgres">
                         <span class="material-symbols-outlined diagram-node-icon-gray">database</span>
                         <span class="diagram-node-label">{{ node.label }}</span>
                      </div>
                      
                      <div *ngIf="node.type === 'api'" class="diagram-node-api">
                         <span class="material-symbols-outlined diagram-node-icon-white">hub</span>
                         <span class="diagram-node-label-small">{{ node.label }}</span>
                      </div>
                      
                      <div *ngIf="node.type === 'client' || node.type === 'mobile'" class="diagram-node-client">
                         <span class="material-symbols-outlined diagram-node-icon-teal">{{ node.type === 'client' ? 'devices' : 'phone_iphone' }}</span>
                         <span class="diagram-node-label">{{ node.label }}</span>
                      </div>
                      
                      <div *ngIf="node.type === 'text'" class="diagram-node-text">
                        <span class="diagram-node-text-inner">{{ node.label }}</span>
                      </div>

                      <!-- Custom Node from Design Studio -->
                      <div *ngIf="node.type === 'custom' && node.config"
                        class="diagram-node-custom"
                        [style.background-color]="getBgColor(node.config.bg_color)"
                        [style.color]="getTextColor(node.config.text_color)"
                        [style.border]="getBorderCss(node.config.border_style)"
                        [style.box-shadow]="getShadowCss(node.config.shadow_style)"
                        [style.border-radius]="node.config.shape === 'circle' ? '50%' : '0'"
                        [style.width]="node.config.shape === 'circle' ? '100px' : 'auto'"
                        [style.height]="node.config.shape === 'circle' ? '100px' : 'auto'">
                        <span *ngIf="node.config.icon" class="material-symbols-outlined" style="margin-bottom: 0.25rem;">{{ node.config.icon }}</span>
                        <span class="diagram-node-label" style="font-size: 10px;">{{ node.label }}</span>
                      </div>

                 </div>
              </div>

            </div>
          </div>

        </ng-container>

        </div>

        <!-- Social Sharing -->
        <app-share-buttons 
          [title]="work.title" 
          [description]="work.blocks[0]?.type === 'p' ? work.blocks[0].content : ''" 
          [image]="work.coverPhoto || ''">
        </app-share-buttons>
      </section>
      
    </div>
  </article>

  <!-- NEXT / PREV FOOTER -->
  <footer class="case-study-footer">
    <a class="btn-back-nav" style="text-transform: uppercase;" routerLink="/works">
      <span class="material-symbols-outlined" style="font-size: 16px;">west</span>
      Back to DB
    </a>
  </footer>
</main>

<main *ngIf="!work && !isLoading" class="not-found-main fade-in-up">
  <div class="not-found-content">
    <h2 class="not-found-title">WORK NOT FOUND</h2>
    <a routerLink="/works" class="not-found-link">Return to Database</a>
  </div>
</main>
