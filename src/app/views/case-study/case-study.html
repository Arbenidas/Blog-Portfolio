<!-- LOADING SKELETON -->
<main *ngIf="isLoading" class="case-study-main">
  <!-- Nav skeleton -->
  <div class="case-study-nav">
    <div class="skel" style="width:130px; height:18px;"></div>
    <div class="skel" style="width:80px; height:18px;"></div>
  </div>

  <div class="article-container">
    <div class="article-inner" style="padding:0; overflow:hidden;">

      <!-- Hero image placeholder -->
      <div class="skel" style="width:100%; height:45vh; border-bottom:2px solid #ddd8d0;"></div>

      <div style="padding:2.5rem; display:flex; flex-direction:column; gap:1rem;">
        <!-- REF badge -->
        <div class="skel" style="width:90px; height:12px;"></div>

        <!-- Title -->
        <div class="skel" style="width:65%; height:42px; margin-top:0.5rem;"></div>
        <!-- Subtitle -->
        <div class="skel" style="width:50%; height:18px;"></div>
        <div style="height:1.5rem;"></div>

        <!-- Data matrix row -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
          <div style="border:2px solid #ddd8d0; padding:1rem; display:flex; flex-direction:column; gap:0.5rem;">
            <div class="skel" style="width:40%; height:11px;"></div>
            <div class="skel" style="width:70%; height:24px;"></div>
            <div class="skel" style="width:55%; height:24px;"></div>
          </div>
          <div style="border:2px solid #ddd8d0; padding:1rem; display:flex; flex-direction:column; gap:0.5rem;">
            <div class="skel" style="width:30%; height:11px;"></div>
            <div class="skel" style="width:90%; height:14px;"></div>
            <div class="skel" style="width:75%; height:14px;"></div>
          </div>
        </div>

        <!-- Content blocks -->
        <div style="display:flex; flex-direction:column; gap:0.6rem; margin-top:1.5rem;">
          <div class="skel" style="width:100%; height:14px;"></div>
          <div class="skel" style="width:100%; height:14px;"></div>
          <div class="skel" style="width:80%; height:14px;"></div>
          <div style="height:0.5rem;"></div>
          <div class="skel" style="width:100%; height:14px;"></div>
          <div class="skel" style="width:100%; height:14px;"></div>
          <div class="skel" style="width:60%; height:14px;"></div>
        </div>
      </div>

    </div>
  </div>
</main>


<main *ngIf="work && !isLoading" class="case-study-main fade-in-up" [class.read-mode]="isReadMode">
  <div class="fixed inset-0 z-0 bg-halftone opacity-10 pointer-events-none" style="background-size: 8px 8px;"></div>
  <div class="coffee-stain" style="top: 2.5rem; right: 5rem; opacity: 0.4; transform: scale(1.5) rotate(90deg);"></div>

  <!-- FLUID WIDGET LAYER (Outside the white paper) -->
  <div class="absolute inset-0 pointer-events-none z-50 overflow-visible hidden md:block">
    <ng-container *ngFor="let widget of work.blocks">
      <div *ngIf="widget.type === 'widget'" class="absolute pointer-events-auto" [style.transform]="'translate3d(' + (widget.data?.x || 0) + 'px, ' + (widget.data?.y || 0) + 'px, 0)'">
         
         <ng-container>
            <div class="pointer-events-none" [innerHTML]="getWidgetHtml(widget.content)"></div>
         </ng-container>

      </div>
    </ng-container>
  </div>

  <!-- BACK NAV -->
  <div class="case-study-nav">
    <a class="btn-back-nav" routerLink="/works">
      <span class="material-symbols-outlined" style="font-size: 16px;">keyboard_return</span>
      RETURN_TO_DB
    </a>
    
    <div style="text-align: right;">
      <span class="classification-label">CLASSIFICATION_LEVEL</span>
      <span class="classification-badge">PUBLIC</span>
    </div>
  </div>

  <!-- 2-COLUMN: ARTICLE + SIDEBAR -->
  <div class="cs-page-grid">

  <article class="article-container" id="pdf-content-area">
    <div class="article-inner">

      <section class="hero-section">
        <div class="hero-ref-badge">REF_ID: {{ (work.id || 'PREVIEW').slice(0, 5) | uppercase }}</div>
        
        <div class="hero-image-wrapper">
          <div class="halftone-dots" style="position: absolute; inset: 0; opacity: 0.4; pointer-events: none; z-index: 10;"></div>
          
          <img *ngIf="work.coverPhoto" [src]="getCoverUrl(work.coverPhoto)" 
               class="hero-image" 
               [ngStyle]="getCoverStyles(work.coverPhoto)" />
          <img *ngIf="!work.coverPhoto && work.blocks.length > 1 && work.blocks[1].type === 'image'" [src]="work.blocks[1].content" class="hero-image" />
          <div *ngIf="!work.coverPhoto && (!work.blocks[1] || work.blocks[1].type !== 'image')" class="hero-no-image">
            <span class="material-symbols-outlined" style="font-size: 8rem;">image</span>
          </div>

          <div class="hero-date-box" style="display:flex; flex-direction:column; gap:0.5rem; align-items:center;">
            <div style="text-align: center; padding: 0 0.5rem;">
              <span class="hero-date-label">DATE</span>
              <span class="hero-date-val">{{ work.createdAt | date:'MM.yyyy' }}</span>
            </div>
            
            <!-- Download Button -->
            <button class="btn-download-hero" (click)="openPdfModal()">
              <span class="material-symbols-outlined" style="font-size:14px; margin-right:4px; vertical-align:-2px;">download</span>
              PDF
            </button>
            
          </div>
        </div>

        <div class="hero-title-box">
          <div class="tape-strip" style="top: -15px; left: 2.5rem; transform: rotate(-3deg);"></div>
          
          <div class="hero-title-inner">
            <h1 class="hero-title">
              {{ work.title }}
            </h1>
            <br>
            <p class="hero-subtitle">
              {{ work.blocks.length > 0 && work.blocks[0].type === 'p' ? work.blocks[0].content : 'Case study data record.' }}
            </p>
          </div>
        </div>
      </section>

      <!-- DATA MATRIX -->
      <section class="data-matrix">
        <div class="data-cell-1">
          <h3 class="data-cell-title data-cell-title-orange">
            <span class="material-symbols-outlined data-cell-icon">build</span> Tech_Stack / Tags
          </h3>
          <div class="tech-tags-container">
            <span *ngFor="let tag of work.tags; let ti = index" 
              class="stamp-tech"
              [ngClass]="'stamp-tech-color-' + (ti % 5)">{{ tag }}</span>
            <span *ngIf="work.tags.length === 0" style="font-family: var(--font-mono); font-size: 0.875rem;">No tags provided</span>
          </div>
        </div>
        <div class="data-cell-2">
          <div style="position: absolute; right: -1rem; bottom: -1rem; opacity: 0.1;">
            <span class="material-symbols-outlined " style="font-size: 150px;">my_location</span>
          </div>
          <h3 class="data-cell-title data-cell-title-charcoal">
            <span class="material-symbols-outlined data-cell-icon">info</span> Meta
          </h3>
          <ul class="meta-list">
            <li>&gt; Created: {{ work.createdAt | date:'medium' }}</li>
            <li>&gt; Updated: {{ work.updatedAt | date:'medium' }}</li>
          </ul>
        </div>
      </section>

      <!-- MAIN CONTENT AREA -->
      <section class="content-section">
        
        <!-- INDEX LOG SIDEBAR (if present) -->
        <aside *ngIf="work.indexLog" class="index-sidebar sidebar-card" style="margin-top: 0; padding: 0;">
          <div class="sidebar-card-header">
            <span class="material-symbols-outlined" style="font-size:14px;">toc</span>
            INDEX_LOG
          </div>
          <ul class="toc-list" style="padding: 0.5rem 0;">
            <li *ngFor="let item of work.indexLog.split('\n'); let ij = index" class="toc-item">
              <span *ngIf="ij === 0" class="toc-bullet">▸</span>
              <span *ngIf="ij !== 0" class="toc-bullet">›</span>
              <span class="toc-text">{{ item.trim() | uppercase }}</span>
            </li>
          </ul>
        </aside>

        <!-- Dynamic Content Blocks -->
        <div class="dynamic-blocks-container">
          <ng-container *ngFor="let block of work.blocks; let i = index">
          
          <div *ngIf="block.type === 'h1'" class="block-h1-container" [id]="'cs-blk-' + i">
            <h2 class="block-h1-title">{{ block.content }}_</h2>
          </div>

          <div *ngIf="block.type === 'h2'" class="block-h2-container" [id]="'cs-blk-' + i">
            <h3 class="block-h2-title">{{ block.content }}_</h3>
          </div>

          <div *ngIf="block.type === 'p'" class="block-p-container">
            <p class="block-p-text">{{ block.content }}</p>
          </div>

          <div *ngIf="block.type === 'image'" class="block-image-container">
            <div class="block-image-box">
              <div class="block-image-label">FIG.{{ i }} : ARCHIVE_IMG</div>
              <img [src]="block.content" class="block-image-img">
            </div>
          </div>

          <div *ngIf="block.type === 'video'" class="block-video-container">
            <div class="block-video-box">
              <div class="block-image-label">FIG.{{ i }} : ARCHIVE_VID</div>
              <!-- YouTube embed -->
              <div *ngIf="isYoutubeUrl(block.content)" class="block-video-embed">
                <iframe [src]="getSafeVideoUrl(block.content)" style="width: 100%; height: 100%;" frameborder="0" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
              </div>
              <!-- Direct video -->
              <div *ngIf="!isYoutubeUrl(block.content)">
                <video [src]="block.content" controls class="block-video-direct"></video>
              </div>
            </div>
          </div>

          <div *ngIf="block.type === 'code'" class="block-code-container">
            <div class="block-code-box">
              <div class="block-code-header">
                <span>&gt; SYSTEM_LOG</span>
              </div>
              <pre class="block-code-pre"><code>{{ block.content }}</code></pre>
            </div>
          </div>

          <div *ngIf="block.type === 'objective-header'" class="block-obj-header-container" [id]="'cs-blk-' + i">
            <h2 class="block-obj-title">{{ block.data?.title }}</h2>
            <span class="block-obj-subtitle">{{ block.data?.subtitle }}</span>
          </div>

          <div *ngIf="block.type === 'objectives'" style="width: 100%;">
            <div class="block-obj-grid">
              <div *ngFor="let obj of block.data" class="block-obj-card">
                <div class="block-obj-label">
                  {{ obj.label }}
                </div>
                <h3 class="block-obj-item-title">{{ obj.title }}</h3>
                <p class="block-obj-desc">{{ obj.desc }}</p>
                <div style="margin-top: auto;">
                  <div class="block-obj-progress-bg">
                    <div class="block-obj-progress-fill" [ngClass]="obj.progress > 50 ? 'block-obj-progress-high' : 'block-obj-progress-low'" [style.width.%]="obj.progress"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="block.type === 'divider'" class="block-divider-container">
            <div class="block-divider-1"></div>
            <div class="block-divider-2"></div>
          </div>

          <!-- tech-stack block is now rendered as fixed meta in the header, skip here -->

          <div *ngIf="block.type === 'comparison'" class="comp-box" [id]="'cs-blk-' + i">
            
            <div class="comp-header">
              <span class="material-symbols-outlined">compare_arrows</span>
              <span>COMPARISON_MATRIX</span>
            </div>

            <div class="comp-row comp-title-bg">
              <div class="comp-input comp-title">{{ block.data.col1Title }}</div>
              <div class="comp-vs">VS</div>
              <div class="comp-input comp-title">{{ block.data.col2Title }}</div>
            </div>

            <div class="comp-row" *ngFor="let row of block.data.rows">
              <div class="comp-input comp-text" style="white-space: pre-wrap;">{{ row.col1 }}</div>
              <div class="comp-vs"></div>
              <div class="comp-input comp-text" style="white-space: pre-wrap;">{{ row.col2 }}</div>
            </div>
          </div>

          <div *ngIf="block.type === 'diagram'" class="block-diagram-container" [id]="'cs-blk-' + i">
            <div class="block-diagram-box">
              <div class="block-diagram-header" style="background: var(--charcoal); color: white; padding: 0.5rem 1rem; font-family: var(--font-mono); font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; gap: 0.5rem; border-bottom: 2px solid var(--charcoal);">
                <span class="material-symbols-outlined" style="font-size: 16px;">account_tree</span>
                <span>SYSTEM_ARCHITECTURE_MAP</span>
                <span style="margin-left: auto; color: #86efac; font-size: 0.65rem;">[LIVE_VIEW]</span>
              </div>
              
              <div class="foblex-canvas-wrapper" 
                   [ngClass]="'size-' + (block.data.size || 'large')"
                   style="background: #f3f4f6; position: relative; overflow: hidden; border: none;">
                <f-flow>
                  <f-canvas>
                    <f-connection *ngFor="let conn of block.data?.connections"
                                  [fOutputId]="conn.from"
                                  [fInputId]="conn.to"
                                  fBehavior="floating"
                                  fType="straight">
                    </f-connection>

                    <div fNode *ngFor="let node of block.data?.nodes"
                            [fNodePosition]="{x: node.x, y: node.y}"
                            class="brutalist-node-strict">

                      <span *ngIf="node.icon" class="material-symbols-outlined strict-icon">
                        {{ node.icon }}
                      </span>
                      
                      <span class="strict-input" style="pointer-events: none;">
                        {{ node.text }}
                      </span>

                      <div fNodeInput [fInputId]="node.id" fInputConnectableSide="left" class="f-port f-port-in" style="pointer-events: none;"></div>
                      <div fNodeOutput [fOutputId]="node.id" fOutputConnectableSide="right" class="f-port f-port-out" style="pointer-events: none;"></div>
                    </div>
                  </f-canvas>
                </f-flow>
              </div>

            </div>
          </div>
          </ng-container>

        </div>

      </section>
      
      <!-- Social Sharing and Footer -->
      <div class="cs-footer-wrap">
        <footer class="log-footer">
          <div class="author-info">
            <div class="author-avatar">
              <span class="material-symbols-outlined author-icon">person</span>
            </div>
            <div>
              <span class="author-label">LOGGED_BY</span>
              <span class="author-name">ADMIN</span>
            </div>
          </div>
          
          <div class="social-actions" style="display: flex; gap: 1rem; align-items: center;">
            <button class="btn-upvote" [class.active]="userHasUpvoted" (click)="toggleUpvote()" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: 2px solid var(--charcoal); background: var(--paper-cream); font-family: var(--font-mono); font-weight: bold; cursor: pointer;">
              <span class="material-symbols-outlined">{{ userHasUpvoted ? 'thumb_up' : 'thumb_up_off_alt' }}</span>
              {{ upvoteCount }} LIKES
            </button>
          </div>
          
          <div class="signed-badge">
            SIGNED: <span class="signed-name">Admin</span>
          </div>
        </footer>
        
        <!-- Comments Section -->
        <div class="comments-section" style="margin-top: 2rem; border-top: 2px dashed var(--charcoal); padding-top: 2rem;">
          <h3 style="font-family: var(--font-display); font-size: 1.5rem; margin-bottom: 1.5rem;">FIELD NOTES ({{ comments.length }})</h3>
          
          <div class="add-comment" style="margin-bottom: 2rem; display: flex; flex-direction: column; gap: 0.5rem;">
            <textarea [(ngModel)]="newCommentText" placeholder="Add a field note..." rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid var(--charcoal); background: var(--white); font-family: var(--font-body); resize: vertical;"></textarea>
            <button (click)="submitComment()" [disabled]="!newCommentText.trim()" style="align-self: flex-end; padding: 0.5rem 1.5rem; background: var(--charcoal); color: white; border: none; font-family: var(--font-mono); font-weight: bold; cursor: pointer;">SUBMIT NOTE</button>
          </div>
          
          <div class="comments-list" style="display: flex; flex-direction: column; gap: 1.5rem;">
            <div *ngFor="let comment of comments" class="comment-item" style="display: flex; gap: 1rem; padding-bottom: 1.5rem; border-bottom: 1px solid rgba(0,0,0,0.1);">
              <div class="comment-avatar" style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: var(--charcoal); display: flex; align-items: center; justify-content: center; color: white;">
                <img *ngIf="comment.profiles?.avatar_url" [src]="comment.profiles.avatar_url" style="width: 100%; height: 100%; object-fit: cover;">
                <span *ngIf="!comment.profiles?.avatar_url" class="material-symbols-outlined">person</span>
              </div>
              <div class="comment-body" style="flex: 1;">
                <div class="comment-meta" style="display: flex; justify-content: space-between; align-items:baseline; margin-bottom: 0.25rem;">
                  <span class="comment-author" style="font-family: var(--font-mono); font-weight: bold; font-size: 0.9rem;">{{ comment.profiles?.username || 'Unknown Agent' }}</span>
                  <span class="comment-date" style="font-family: var(--font-mono); font-size: 0.75rem; color: #666;">{{ comment.created_at | date:'short' }}</span>
                </div>
                <div class="comment-content" style="font-family: var(--font-body); font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap;">{{ comment.content }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="share-container">
          <app-share-buttons 
            [title]="work.title" 
            [description]="work.blocks[0]?.type === 'p' ? work.blocks[0].content : ''" 
            [image]="work.coverPhoto || ''">
          </app-share-buttons>
        </div>
      </div>

    </div>
  </article>

  <!-- RIGHT: STICKY SIDEBAR -->
  <aside class="log-sidebar">

    <!-- Reading Info -->
    <div class="sidebar-card">
      <div class="sidebar-card-header">
        <span class="material-symbols-outlined" style="font-size:14px;">schedule</span>
        SYS_INFO
      </div>
      <div class="sidebar-meta-row">
        <span class="sidebar-meta-label">Read time</span>
        <span class="sidebar-meta-val">~{{ readingTime }} min</span>
      </div>
      <div class="sidebar-meta-row">
        <span class="sidebar-meta-label">Filed</span>
        <span class="sidebar-meta-val">{{ work.createdAt | date:'dd MMM yy' }}</span>
      </div>
      <div class="sidebar-meta-row" style="border-bottom:none;">
        <span class="sidebar-meta-label">Tags</span>
        <span class="sidebar-meta-val" style="color:var(--primary);">{{ work.tags.length }}</span>
      </div>
    </div>

    <!-- Read Mode Button -->
    <button class="sidebar-card btn-read-mode-toggle" (click)="toggleReadMode()" style="justify-content: center; padding: 0.5rem; text-align: center; font-family: var(--font-mono); font-size: 0.75rem; font-weight: bold; color: var(--charcoal); cursor: pointer; transition: background-color 0.2s, color 0.2s; display: flex; align-items: center; gap: 0.4rem; background-color: var(--charcoal); color: white;">
      <span class="material-symbols-outlined" style="font-size:16px;">chrome_reader_mode</span>
      MODO LECTURA
    </button>

    <!-- Table of Contents -->

    <div *ngIf="tocItems.length > 0" class="sidebar-card">
      <div class="sidebar-card-header">
        <span class="material-symbols-outlined" style="font-size:14px;">toc</span>
        INDEX_LOG
      </div>
      <nav class="toc-list">
        <button *ngFor="let item of tocItems"
           class="toc-item"
           [class.toc-item-h2]="item.level === 2"
           [class.toc-item-active]="activeSectionId === item.id"
           (click)="scrollToSection(item.id)">
          <span *ngIf="item.icon" class="material-symbols-outlined toc-icon">{{ item.icon }}</span>
          <span *ngIf="!item.icon" class="toc-bullet">{{ item.level === 1 ? '▸' : '›' }}</span>
          <span class="toc-text">{{ item.text | uppercase }}</span>
        </button>
      </nav>
    </div>

    <div *ngIf="work.tags.length > 0" class="sidebar-card">
      <div class="sidebar-card-header">
        <span class="material-symbols-outlined" style="font-size:14px;">label</span>
        FIELD_TAGS
      </div>
      <div class="sidebar-tags">
        <span *ngFor="let tag of work.tags" class="sidebar-tag">#{{ tag }}</span>
      </div>
    </div>

    <!-- Bibliography Button -->
    <button *ngIf="bibliographyBlock" class="sidebar-card" (click)="toggleBibliography($event)" style="justify-content: center; padding: 0.5rem; text-align: center; font-family: var(--font-mono); font-size: 0.75rem; font-weight: bold; color: var(--charcoal); cursor: pointer; transition: background-color 0.2s;">
      <span class="material-symbols-outlined" style="font-size:14px; margin-right: 0.25rem;">library_books</span>
      REFERENCES
    </button>

    <!-- Back button -->
    <a class="sidebar-back-btn" routerLink="/works">
      <span class="material-symbols-outlined" style="font-size:14px;">west</span>
      Back to Database
    </a>

  </aside>
  </div><!-- /cs-page-grid -->


  <!-- Bibliography Overlay Dialog -->
  <div *ngIf="showBibliography" class="biblio-overlay" (click)="toggleBibliography()">
    <div class="bibliography-note fade-in-up" (click)="$event.stopPropagation()">
      <div class="tape-strip-sm"></div>
      <h4 class="bibliography-title">Bibliography / Refs</h4>
      <div class="bibliography-content" style="white-space: pre-wrap;">{{ bibliographyBlock.content }}</div>
    </div>
  </div>


  <!-- NEXT / PREV FOOTER -->
  <footer class="case-study-footer">
    <a class="btn-back-nav" style="text-transform: uppercase;" routerLink="/works">
      <span class="material-symbols-outlined" style="font-size: 16px;">west</span>
      Back to DB
    </a>
  </footer>
  
  <!-- Floating Exit Read Mode Button (only visible in read mode) -->
  <button *ngIf="isReadMode" class="btn-floating-exit-read-mode fade-in-up" (click)="toggleReadMode()">
    <span class="material-symbols-outlined" style="font-size: 20px;">close_fullscreen</span>
    SALIR MODO LECTURA
  </button>

  <!-- Ad Modal Overlay -->

  <app-ad-modal 
    #adModal 
    [isOpen]="isModalOpen" 
    (downloadReady)="generatePdf()" 
    (closeEvent)="isModalOpen = false">
  </app-ad-modal>

</main>

<main *ngIf="!work && !isLoading" class="not-found-main fade-in-up">
  <div class="not-found-content">
    <h2 class="not-found-title">WORK NOT FOUND</h2>
    <a routerLink="/works" class="not-found-link">Return to Database</a>
  </div>
</main>
