<!-- LOADING SKELETON -->
<main *ngIf="isLoading" class="case-study-main">
  <div class="case-study-nav">
     <div style="width: 120px; height: 20px; background-color: #e5e7eb; animation: pulse 2s infinite;"></div>
  </div>
  <div class="article-container" style="opacity: 0.7; animation: pulse 2s infinite;">
     <div class="article-inner" style="padding: 0;">
        <div class="hero-image-wrapper" style="background-color: #e5e7eb; height: 50vh; width: 100%;"></div>
        <div style="padding: 2.5rem;">
           <div style="height: 48px; background-color: #d1d5db; width: 60%; margin-bottom: 1rem;"></div>
           <div style="height: 24px; background-color: #e5e7eb; width: 40%; margin-bottom: 3rem;"></div>
           <div style="height: 16px; background-color: #e5e7eb; width: 100%; margin-bottom: 0.5rem;"></div>
           <div style="height: 16px; background-color: #e5e7eb; width: 100%; margin-bottom: 0.5rem;"></div>
           <div style="height: 16px; background-color: #e5e7eb; width: 80%;"></div>
        </div>
     </div>
  </div>
</main>

<main *ngIf="work && !isLoading" class="case-study-main fade-in-up">
  <div class="fixed inset-0 z-0 bg-halftone opacity-10 pointer-events-none" style="background-size: 8px 8px;"></div>
  <div class="coffee-stain" style="top: 2.5rem; right: 5rem; opacity: 0.4; transform: scale(1.5) rotate(90deg);"></div>

  <!-- FLUID WIDGET LAYER (Outside the white paper) -->
  <div class="absolute inset-0 pointer-events-none z-50 overflow-visible hidden md:block">
    <ng-container *ngFor="let widget of work.blocks">
      <div *ngIf="widget.type === 'widget'" class="absolute pointer-events-auto" [style.transform]="'translate3d(' + (widget.data?.x || 0) + 'px, ' + (widget.data?.y || 0) + 'px, 0)'">
         
         <ng-container>
            <div class="pointer-events-none" [innerHTML]="getWidgetHtml(widget.content)"></div>
         </ng-container>

      </div>
    </ng-container>
  </div>

  <!-- BACK NAV -->
  <div class="case-study-nav">
    <a class="btn-back-nav" routerLink="/works">
      <span class="material-symbols-outlined" style="font-size: 16px;">keyboard_return</span>
      RETURN_TO_DB
    </a>
    
    <div style="text-align: right;">
      <span class="classification-label">CLASSIFICATION_LEVEL</span>
      <span class="classification-badge">PUBLIC</span>
    </div>
  </div>

  <article class="article-container">
    <div class="article-inner">
      
      <!-- HERO SECTION -->
      <section class="hero-section">
        <div class="hero-ref-badge">REF_ID: {{ (work.id || 'PREVIEW').slice(0, 5) | uppercase }}</div>
        
        <div class="hero-image-wrapper">
          <div class="halftone-dots" style="position: absolute; inset: 0; opacity: 0.4; pointer-events: none; z-index: 10;"></div>
          
          <img *ngIf="work.coverPhoto" [src]="getCoverUrl(work.coverPhoto)" 
               class="hero-image" 
               [ngStyle]="getCoverStyles(work.coverPhoto)" />
          <img *ngIf="!work.coverPhoto && work.blocks.length > 1 && work.blocks[1].type === 'image'" [src]="work.blocks[1].content" class="hero-image" />
          <div *ngIf="!work.coverPhoto && (!work.blocks[1] || work.blocks[1].type !== 'image')" class="hero-no-image">
            <span class="material-symbols-outlined" style="font-size: 8rem;">image</span>
          </div>

          <div class="hero-date-box">
            <div style="text-align: center; padding: 0 0.5rem;">
              <span class="hero-date-label">DATE</span>
              <span class="hero-date-val">{{ work.createdAt | date:'MM.yyyy' }}</span>
            </div>
          </div>
        </div>

        <div class="hero-title-box">
          <div class="tape-strip" style="top: -15px; left: 2.5rem; transform: rotate(-3deg);"></div>
          
          <div class="hero-title-inner">
            <h1 class="hero-title">
              {{ work.title }}
            </h1>
            <br>
            <p class="hero-subtitle">
              {{ work.blocks.length > 0 && work.blocks[0].type === 'p' ? work.blocks[0].content : 'Case study data record.' }}
            </p>
          </div>
        </div>
      </section>

      <!-- DATA MATRIX -->
      <section class="data-matrix">
        <div class="data-cell-1">
          <h3 class="data-cell-title data-cell-title-orange">
            <span class="material-symbols-outlined data-cell-icon">build</span> Tech_Stack / Tags
          </h3>
          <div class="tech-tags-container">
            <span *ngFor="let tag of work.tags; let ti = index" 
              class="stamp-tech"
              [ngClass]="'stamp-tech-color-' + (ti % 5)">{{ tag }}</span>
            <span *ngIf="work.tags.length === 0" style="font-family: var(--font-mono); font-size: 0.875rem;">No tags provided</span>
          </div>
        </div>
        <div class="data-cell-2">
          <div style="position: absolute; right: -1rem; bottom: -1rem; opacity: 0.1;">
            <span class="material-symbols-outlined " style="font-size: 150px;">my_location</span>
          </div>
          <h3 class="data-cell-title data-cell-title-charcoal">
            <span class="material-symbols-outlined data-cell-icon">info</span> Meta
          </h3>
          <ul class="meta-list">
            <li>&gt; Created: {{ work.createdAt | date:'medium' }}</li>
            <li>&gt; Updated: {{ work.updatedAt | date:'medium' }}</li>
          </ul>
        </div>
      </section>

      <!-- MAIN CONTENT AREA -->
      <section class="content-section">
        
        <!-- INDEX LOG SIDEBAR (if present) -->
        <aside *ngIf="work.indexLog" class="index-sidebar">
          <div class="index-box">
             <div class="index-box-bg"></div>
             
             <h3 class="index-title">INDEX_LOG</h3>
             <ul class="index-list">
                 <li *ngFor="let item of work.indexLog.split('\n'); let ij = index" class="index-item">
                   <div class="index-dot" [ngClass]="ij === 0 ? 'index-dot-orange' : 'index-dot-charcoal'"></div>
                   {{ item.trim() | uppercase }}
                 </li>
             </ul>
             
             <div class="index-divider"></div>
             
             <button class="btn-download-pdf mt-6">
               DOWNLOAD PDF
             </button>
          </div>
        </aside>

        <!-- Dynamic Content Blocks -->
        <div class="dynamic-blocks-container">
          <ng-container *ngFor="let block of work.blocks; let i = index">
          
          <div *ngIf="block.type === 'h1'" class="block-h1-container">
            <h2 class="block-h1-title">{{ block.content }}_</h2>
          </div>

          <div *ngIf="block.type === 'h2'" class="block-h2-container">
            <h3 class="block-h2-title">{{ block.content }}_</h3>
          </div>

          <div *ngIf="block.type === 'p'" class="block-p-container">
            <p class="block-p-text">{{ block.content }}</p>
          </div>

          <div *ngIf="block.type === 'image'" class="block-image-container">
            <div class="block-image-box">
              <div class="block-image-label">FIG.{{ i }} : ARCHIVE_IMG</div>
              <img [src]="block.content" class="block-image-img">
            </div>
          </div>

          <div *ngIf="block.type === 'video'" class="block-video-container">
            <div class="block-video-box">
              <div class="block-image-label">FIG.{{ i }} : ARCHIVE_VID</div>
              <!-- YouTube embed -->
              <div *ngIf="isYoutubeUrl(block.content)" class="block-video-embed">
                <iframe [src]="getSafeVideoUrl(block.content)" style="width: 100%; height: 100%;" frameborder="0" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
              </div>
              <!-- Direct video -->
              <div *ngIf="!isYoutubeUrl(block.content)">
                <video [src]="block.content" controls class="block-video-direct"></video>
              </div>
            </div>
          </div>

          <div *ngIf="block.type === 'code'" class="block-code-container">
            <div class="block-code-box">
              <div class="block-code-header">
                <span>&gt; SYSTEM_LOG</span>
              </div>
              <pre class="block-code-pre"><code>{{ block.content }}</code></pre>
            </div>
          </div>

          <div *ngIf="block.type === 'objective-header'" class="block-obj-header-container">
            <h2 class="block-obj-title">{{ block.data?.title }}</h2>
            <span class="block-obj-subtitle">{{ block.data?.subtitle }}</span>
          </div>

          <div *ngIf="block.type === 'objectives'" style="width: 100%;">
            <div class="block-obj-grid">
              <div *ngFor="let obj of block.data" class="block-obj-card">
                <div class="block-obj-label">
                  {{ obj.label }}
                </div>
                <h3 class="block-obj-item-title">{{ obj.title }}</h3>
                <p class="block-obj-desc">{{ obj.desc }}</p>
                <div style="margin-top: auto;">
                  <div class="block-obj-progress-bg">
                    <div class="block-obj-progress-fill" [ngClass]="obj.progress > 50 ? 'block-obj-progress-high' : 'block-obj-progress-low'" [style.width.%]="obj.progress"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="block.type === 'divider'" class="block-divider-container">
            <div class="block-divider-1"></div>
            <div class="block-divider-2"></div>
          </div>

          <!-- tech-stack block is now rendered as fixed meta in the header, skip here -->

          <div *ngIf="block.type === 'comparison'" class="comp-box">
            
            <div class="comp-header">
              <span class="material-symbols-outlined">compare_arrows</span>
              <span>COMPARISON_MATRIX</span>
            </div>

            <div class="comp-row comp-title-bg">
              <div class="comp-input comp-title">{{ block.data.col1Title }}</div>
              <div class="comp-vs">VS</div>
              <div class="comp-input comp-title">{{ block.data.col2Title }}</div>
            </div>

            <div class="comp-row" *ngFor="let row of block.data.rows">
              <div class="comp-input comp-text" style="white-space: pre-wrap;">{{ row.col1 }}</div>
              <div class="comp-vs"></div>
              <div class="comp-input comp-text" style="white-space: pre-wrap;">{{ row.col2 }}</div>
            </div>
          </div>

          <div *ngIf="block.type === 'diagram'" class="block-diagram-container">
            <div class="block-diagram-box">
              <div class="block-diagram-header" style="background: var(--charcoal); color: white; padding: 0.5rem 1rem; font-family: var(--font-mono); font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; gap: 0.5rem; border-bottom: 2px solid var(--charcoal);">
                <span class="material-symbols-outlined" style="font-size: 16px;">account_tree</span>
                <span>SYSTEM_ARCHITECTURE_MAP</span>
                <span style="margin-left: auto; color: #86efac; font-size: 0.65rem;">[LIVE_VIEW]</span>
              </div>
              
              <div class="foblex-canvas-wrapper" 
                   [ngClass]="'size-' + (block.data.size || 'large')"
                   style="background: #f3f4f6; position: relative; overflow: hidden; border: none;">
                <f-flow>
                  <f-canvas>
                    <f-connection *ngFor="let conn of block.data?.connections"
                                  [fOutputId]="conn.from"
                                  [fInputId]="conn.to"
                                  fBehavior="floating"
                                  fType="straight">
                    </f-connection>

                    <div fNode *ngFor="let node of block.data?.nodes"
                            [fNodePosition]="{x: node.x, y: node.y}"
                            class="brutalist-node-strict">

                      <span *ngIf="node.icon" class="material-symbols-outlined strict-icon">
                        {{ node.icon }}
                      </span>
                      
                      <span class="strict-input" style="pointer-events: none;">
                        {{ node.text }}
                      </span>

                      <div fNodeInput [fInputId]="node.id" fInputConnectableSide="left" class="f-port f-port-in" style="pointer-events: none;"></div>
                      <div fNodeOutput [fOutputId]="node.id" fOutputConnectableSide="right" class="f-port f-port-out" style="pointer-events: none;"></div>
                    </div>
                  </f-canvas>
                </f-flow>
              </div>

            </div>
          </div>

        </ng-container>

        </div>

      </section>
      
      <!-- Social Sharing - Added more margin and consistent padding -->
      <div class="px-6 pt-8 pb-12 md:px-12 md:pb-20">
        <app-share-buttons 
          [title]="work.title" 
          [description]="work.blocks[0]?.type === 'p' ? work.blocks[0].content : ''" 
          [image]="work.coverPhoto || ''">
        </app-share-buttons>
      </div>

    </div>
  </article>

  <!-- NEXT / PREV FOOTER -->
  <footer class="case-study-footer">
    <a class="btn-back-nav" style="text-transform: uppercase;" routerLink="/works">
      <span class="material-symbols-outlined" style="font-size: 16px;">west</span>
      Back to DB
    </a>
  </footer>
</main>

<main *ngIf="!work && !isLoading" class="not-found-main fade-in-up">
  <div class="not-found-content">
    <h2 class="not-found-title">WORK NOT FOUND</h2>
    <a routerLink="/works" class="not-found-link">Return to Database</a>
  </div>
</main>
