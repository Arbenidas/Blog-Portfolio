<main *ngIf="log" class="field-log-main">
  <div class="coffee-stain" style="top: 8rem; left: -2.5rem; opacity: 0.5;"></div>
  <div class="field-log-bg"></div>

  <!-- FLUID WIDGET LAYER (Outside the white paper) -->
  <div class="absolute inset-0 pointer-events-none z-50 overflow-visible hidden md:block">
    <ng-container *ngFor="let widget of log.blocks">
      <div *ngIf="widget.type === 'widget'" class="absolute pointer-events-auto" [style.transform]="'translate3d(' + (widget.data?.x || 0) + 'px, ' + (widget.data?.y || 0) + 'px, 0)'">
         
         <ng-container>
            <div class="pointer-events-none" [innerHTML]="getWidgetHtml(widget.content)"></div>
         </ng-container>

      </div>
    </ng-container>
  </div>

  <div class="field-log-nav">
    <a class="btn-back-nav" routerLink="/logs">
      <span class="material-symbols-outlined" style="font-size: 16px;">arrow_back</span>
      RETURN_TO_ARCHIVES
    </a>
  </div>

  <article class="article-container">
    <div class="article-inner">
      <!-- Decoratives -->
      <div class="tape-strip" style="top: -10px; left: 5%; transform: rotate(-2deg);"></div>
      <div class="file-ref-badge">
        <span class="file-ref-val">{{ (log.id || 'PRV').slice(0, 3) | uppercase }}</span>
        <span class="file-ref-label">FILE_REF</span>
      </div>
      
      <!-- Meta Header -->
      <header class="log-header">
        <div *ngIf="log.coverPhoto" class="cover-photo-box">
           <img [src]="log.coverPhoto" class="cover-photo-img" />
        </div>
        <div class="meta-badges">
          <span class="meta-badge meta-badge-status">STATUS: LOGGED</span>
          <span class="meta-badge meta-badge-date">{{ log.createdAt | date:'MMM.dd.yyyy' }}</span>
        </div>
        <h1 class="log-title">
          {{ log.title }}
        </h1>
        <div class="log-tags">
          <a *ngFor="let tag of log.tags" class="log-tag" href="#">#{{ tag }}</a>
        </div>
      </header>

      <!-- Content Body -->
      <div class="log-content">
        
        <ng-container *ngFor="let block of log.blocks; let first = first">
          
          <p *ngIf="block.type === 'p'" 
             [ngClass]="first ? 'block-p-first' : ''">
             {{ block.content }}
          </p>

          <h2 *ngIf="block.type === 'h1'" class="block-h1">
            {{ block.content }}
          </h2>

          <h3 *ngIf="block.type === 'h2'" class="block-h2">
            {{ block.content }}
          </h3>

          <div *ngIf="block.type === 'code'" class="block-code">
            <pre><code>{{ block.content }}</code></pre>
          </div>

          <div *ngIf="block.type === 'image'" class="block-image">
             <div class="block-image-tape"></div>
             <img [src]="block.content" class="block-image-img riso-print">
          </div>

          <div *ngIf="block.type === 'video'" class="block-video">
            <div class="block-image-tape"></div>
            <!-- YouTube embed -->
            <div *ngIf="isYoutubeUrl(block.content)" class="block-video-embed">
              <iframe [src]="getSafeVideoUrl(block.content)" style="width: 100%; height: 100%;" frameborder="0" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
            </div>
            <!-- Direct video -->
            <div *ngIf="!isYoutubeUrl(block.content)">
              <video [src]="block.content" controls class="block-video-direct"></video>
            </div>
          </div>

          <div *ngIf="block.type === 'diagram'" class="block-diagram">
            <div class="block-diagram-box">
              <div class="block-diagram-label">
                <span class="material-symbols-outlined" style="font-size: 12px;">account_tree</span> SYSTEM_DIAGRAM
              </div>
              
              <div class="block-diagram-canvas">

                <!-- SVG Arrow Overlay -->
                <svg style="position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
                  <defs>
                    <marker id="fl-arrowhead-solid" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto"><polygon points="0 0, 12 4, 0 8" fill="#1a1a1a" /></marker>
                    <marker id="fl-arrowhead-dashed" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto"><polygon points="0 0, 12 4, 0 8" fill="#1a1a1a" /></marker>
                    <marker id="fl-arrowhead-zigzag" markerWidth="14" markerHeight="10" refX="12" refY="5" orient="auto"><polygon points="0 0, 14 5, 0 10" fill="#d94e1e" /></marker>
                    <marker id="fl-arrowhead-graffiti" markerWidth="16" markerHeight="12" refX="14" refY="6" orient="auto"><circle cx="8" cy="6" r="5" fill="#1a1a1a" opacity="0.7" /></marker>
                    <marker id="fl-arrowhead-dotted" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto"><circle cx="5" cy="5" r="4" fill="#1a1a1a" /></marker>
                  </defs>
                  <ng-container *ngFor="let arrow of block.data?.arrows">
                    <line
                      [attr.x1]="getNodeEdgePoint(block, arrow.from, arrow.to).x"
                      [attr.y1]="getNodeEdgePoint(block, arrow.from, arrow.to).y"
                      [attr.x2]="getNodeEdgePoint(block, arrow.to, arrow.from).x"
                      [attr.y2]="getNodeEdgePoint(block, arrow.to, arrow.from).y"
                      [attr.stroke]="arrow.type === 'zigzag' ? '#d94e1e' : '#1a1a1a'"
                      [attr.stroke-width]="getArrowStrokeWidth(arrow.type)"
                      [attr.stroke-dasharray]="getArrowDashArray(arrow.type) === 'none' ? null : getArrowDashArray(arrow.type)"
                      [attr.marker-end]="getMarkerUrl(arrow.type)"
                      [attr.opacity]="arrow.type === 'graffiti' ? 0.6 : 1"
                      stroke-linecap="round"
                    />
                  </ng-container>
                </svg>
                <div *ngFor="let node of block.data?.nodes" class="diagram-node" [style.left.px]="node.x" [style.top.px]="node.y">
                  <div *ngIf="node.type === 'postgres'" class="diagram-node-postgres">
                    <span class="material-symbols-outlined diagram-node-icon-gray">database</span>
                    <div class="diagram-node-label">{{node.label || 'Database'}}</div>
                  </div>
                  <div *ngIf="node.type === 'api'" class="diagram-node-api">
                    <span class="material-symbols-outlined diagram-node-icon-white">hub</span>
                    <div class="diagram-node-label-small">{{node.label || 'API'}}</div>
                  </div>
                  <div *ngIf="node.type === 'client' || node.type === 'mobile'" class="diagram-node-client">
                    <span class="material-symbols-outlined diagram-node-icon-teal">{{ node.type === 'client' ? 'devices' : 'phone_iphone' }}</span>
                    <div class="diagram-node-label">{{node.label || 'Client'}}</div>
                  </div>
                  <div *ngIf="node.type === 'text'" class="diagram-node-text">
                    <div class="diagram-node-text-inner">{{node.label || 'Note'}}</div>
                  </div>

                  <!-- Custom Node from Design Studio -->
                  <div *ngIf="node.type === 'custom' && node.config"
                    class="diagram-node-custom"
                    [style.background-color]="getBgColor(node.config.bg_color)"
                    [style.color]="getTextColor(node.config.text_color)"
                    [style.border]="getBorderCss(node.config.border_style)"
                    [style.box-shadow]="getShadowCss(node.config.shadow_style)"
                    [style.border-radius]="node.config.shape === 'circle' ? '50%' : '0'"
                    [style.width]="node.config.shape === 'circle' ? '100px' : 'auto'"
                    [style.height]="node.config.shape === 'circle' ? '100px' : 'auto'">
                    <span *ngIf="node.config.icon" class="material-symbols-outlined" style="margin-bottom: 0.25rem;">{{ node.config.icon }}</span>
                    <span class="diagram-node-label" style="font-size: 10px;">{{ node.label }}</span>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </ng-container>

      </div>

      <!-- Social Sharing -->
      <app-share-buttons 
        [title]="log.title" 
        [description]="log.blocks[0].type === 'p' ? log.blocks[0].content : ''" 
        [image]="log.coverPhoto || ''">
      </app-share-buttons>

      <!-- Footer / Author Block -->
      <footer class="log-footer">
        <div class="author-info">
          <div class="author-avatar">
            <span class="material-symbols-outlined author-icon">person</span>
          </div>
          <div>
            <span class="author-label">LOGGED_BY</span>
            <span class="author-name">ADMIN</span>
          </div>
        </div>
        
        <div class="signed-badge">
          SIGNED: <span class="signed-name">Admin</span>
        </div>
      </footer>
    </div>
  </article>

  <!-- Navigation -->
  <div class="bottom-nav">
    <a class="btn-bottom-nav" routerLink="/logs">
      <span class="material-symbols-outlined" style="font-size: 14px;">arrow_back</span>
      ARCHIVES
    </a>
    <span class="eof-label">EOF</span>
  </div>
</main>

<main *ngIf="!log" class="not-found-main">
  <div class="not-found-content">
    <h2 class="not-found-title">LOG NOT FOUND</h2>
    <a routerLink="/logs" class="not-found-link">Return to Archives</a>
  </div>
</main>
